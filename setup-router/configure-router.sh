#!/bin/bash

RUN_USER=tools
export ROUTER_HOME=/home/router
export ROUTER_DOMAIN=home.shkits.com
ROUTER_INTERNAL_IPV4=172.23.1.10
ROUTER_DATA_ROOT_DIR=/data
ROUTER_LOG_ROOT_DIR=$ROUTER_DATA_ROOT_DIR/logs
ROUTER_LOCAL_LAN_INTERFACE='{ lo, br0, enp2s0 , vlan0 }'
ROUTER_IPV6_RADVD_NDP_DEVICE=(enp2s0 vlan0)
#sysctl -w net.ipv6.conf.${ROUTER_IPV6_RADVD_NDP_DEVICE[@]}.proxy_ndp=1
#sysctl -w net.ipv6.conf.${ROUTER_IPV6_RADVD_NDP_DEVICE[@]}.accept_ra=2
# Edit $ROUTER_HOME/vlan/vlan-setup-bridge.sh to make sure bridge and vlan tag will be set correctly

ROUTER_INTERNAL_SERVICE_PRIVATE_PORT_TCP="53,80,139,443,445,853,5432,6543,6800,8080"
ROUTER_INTERNAL_SERVICE_PUBLIC_PORT_TCP="6096,6349,6443,6881,6882,6883,8371,8372,8373,36000"
ROUTER_INTERNAL_SERVICE_PRIVATE_PORT_UDP="53,67,68,80,137,138,443,547,1900,3478,6800,8080,10001"
ROUTER_INTERNAL_SERVICE_PUBLIC_PORT_UDP="6096,6349,6443,6881,6882,6883,8371,8372,8373"
ROUTER_INTERNAL_SERVICE_PORT_TCP="${ROUTER_INTERNAL_SERVICE_PRIVATE_PORT_TCP},${ROUTER_INTERNAL_SERVICE_PUBLIC_PORT_TCP}"
ROUTER_INTERNAL_SERVICE_PORT_UDP="${ROUTER_INTERNAL_SERVICE_PRIVATE_PORT_UDP},${ROUTER_INTERNAL_SERVICE_PUBLIC_PORT_UDP}"
ROUTER_INTERNAL_SERVICE_PORT_ALL="$(echo "${ROUTER_INTERNAL_SERVICE_PORT_TCP//,/ } ${ROUTER_INTERNAL_SERVICE_PORT_UDP//,/ }" | xargs -r -n 1 echo | sort -u -n)"
ROUTER_INTERNAL_SERVICE_PORT_ALL="$(echo "$ROUTER_INTERNAL_SERVICE_PORT_ALL" | tr '\n' ',' | sed -E 's;,*$;;g' | sed -E 's;^,*;;g')"
# NTP Port: 123
ROUTER_INTERNAL_DIRECTLY_VISIT_UDP_DPORT="123"
# Port list:
#   - cockpit: 443
#   - emby: 6096
#   - syncthing-relay: 6349
#   - nextcloud: 6443
#   - aria2: 6881-6883
#   - v2ray: 6371-6373

# Unifi controller
UNIFI_CONTROLLER_WEB_PORT=6543

DNSMASQ_DNS_PORT=6053
DNSMASQ_ENABLE_DNS=0
DNSMASQ_ENABLE_DHCP=1
DNSMASQ_ENABLE_IPV6_NDP=0
DNSMASQ_ENABLE_DHCP_EXCEPT_INTERFACE=(ppp0 ppp1)

GEOIP_GEOSITE_ETC_DIR=$ROUTER_HOME/etc/v2ray

SMARTDNS_ENABLE=0
SMARTDNS_DNS_PORT=6153
SMARTDNS_ETC_DIR=$ROUTER_HOME/etc/smartdns
SMARTDNS_LOG_DIR=$ROUTER_LOG_ROOT_DIR/smartdns
SMARTDNS_APPEND_CONFIGURE=""

COREDNS_DNS_PORT=53
NEXTDNS_PRIVATE_TLS_DOMAIN=steering.nextdns.io

# Use radvd and ndp and disable NAT6
NAT_SETUP_SKIP_IPV6=1

ACMESH_SSL_DIR=$ROUTER_HOME/acme.sh/ssl
SAMBA_DATA_DIR=$ROUTER_DATA_ROOT_DIR/samba
REDIS_PRIVATE_NETWORK_NAME=local-redis
REDIS_PRIVATE_NETWORK_IP=10.85.0.251
REDIS_PORT=6379
REDIS_DATA_DIR=$ROUTER_DATA_ROOT_DIR/redis/data
POSTGRESQL_ADMIN_USER=owent
POSTGRESQL_DATA_DIR=$SAMBA_DATA_DIR/postgresql/data
POSTGRESQL_SHM_SIZE=1024 # MB
POSTGRESQL_MAX_CONNECTIONS=200
POSTGRESQL_PORT=5432
NEXTCLOUD_DATA_DIR=$SAMBA_DATA_DIR/nextcloud/data
NEXTCLOUD_APPS_DIR=$SAMBA_DATA_DIR/nextcloud/apps
NEXTCLOUD_ETC_DIR=$SAMBA_DATA_DIR/nextcloud/etc
NEXTCLOUD_EXTERNAL_DIR=$SAMBA_DATA_DIR/nextcloud/external
NEXTCLOUD_REVERSE_ROOT_DIR=""                             # Set non empty and use fpm docker image when success
NEXTCLOUD_TRUSTED_DOMAINS=""                              # nextcloud domains and IPs
NEXTCLOUD_CACHE_OPTIONS=()                                # --network=$REDIS_PRIVATE_NETWORK_NAME -e REDIS_HOST=$REDIS_PRIVATE_NETWORK_IP -e REDIS_HOST_PORT=$REDIS_PORT -e REDIS_HOST_PASSWORD=
ONLYOFFICE_DATA_DIR=$ROUTER_DATA_ROOT_DIR/onlyoffice/data # /var/www/onlyoffice/Data
ONLYOFFICE_CACHE_DIR=$ROUTER_DATA_ROOT_DIR/onlyoffice/lib # /var/lib/onlyoffice
ONLYOFFICE_DB_DIR=$ROUTER_DATA_ROOT_DIR/onlyoffice/db     # /var/lib/postgresql
ONLYOFFICE_LOG_DIR=$ROUTER_LOG_ROOT_DIR/onlyoffice        # /var/log/onlyoffice
ONLYOFFICE_JWT_SECRET=                                    # -e JWT_SECRET=$ONLYOFFICE_JWT_SECRET
ONLYOFFICE_DB_TYPE=postgres                               # -e DB_TYPE=$ONLYOFFICE_DB_TYPE (postgres/mariadb/mysql)
ONLYOFFICE_DB_HOST=127.0.0.1                              # -e DB_HOST=$ONLYOFFICE_DB_HOST
ONLYOFFICE_DB_PORT=$POSTGRESQL_PORT                       # -e DB_PORT=$ONLYOFFICE_DB_PORT
ONLYOFFICE_DB_NAME=onlyoffice                             # -e DB_NAME=$ONLYOFFICE_DB_NAME
ONLYOFFICE_DB_USER=onlyoffice                             # -e DB_USER=$ONLYOFFICE_DB_USER
ONLYOFFICE_DB_PASSWD=                                     # -e DB_PWD=$ONLYOFFICE_DB_PASSWD
ONLYOFFICE_CACHE_OPTIONS=()                               # --network=$REDIS_PRIVATE_NETWORK_NAME -e REDIS_SERVER_HOST=$REDIS_PRIVATE_NETWORK_IP -e REDIS_SERVER_PORT=$REDIS_PORT

TPROXY_SETUP_USING_GEOIP=0
TPROXY_SETUP_IPSET=0
TPROXY_SETUP_SMARTDNS=0
TPROXY_SETUP_DNSMASQ=0
TPROXY_SETUP_COREDNS=1
TPROXY_SETUP_WITHOUT_IPV6=1

TPROXY_SETUP_COREDNS_WITH_NFTABLES=1
TPROXY_SETUP_NFTABLES=1 # Set 1 to use iptables/ebtables
TPROXY_WHITELIST_IPV4=("91.108.56.0/22" "95.161.64.0/20" "91.108.4.0/22" "91.108.8.0/22" "149.154.160.0/22" "149.154.164.0/22" "8.8.8.8" "8.8.4.4")
TPROXY_WHITELIST_IPV6=("2001:4860:4860::8888" "2001:4860:4860::8844")
TPROXY_BLACKLIST_VLAN_TAGS=(5 6)

# Syncthing
if [[ -e "$ROUTER_HOME/syncthing/configure-server.sh" ]]; then
  source "$ROUTER_HOME/syncthing/configure-server.sh"
elif [[ -e "$(dirname "$0")/syncthing/configure-server.sh" ]]; then
  source "$(dirname "$0")/syncthing/configure-server.sh"
fi

# Emby
EMBY_CONFIG_DIR="$ROUTER_DATA_ROOT_DIR/emby/config"
EMBY_DATA_MEDIA_DIR="$ROUTER_DATA_ROOT_DIR/emby/data/media"
EMBY_DATA_CACHE_DIR="$ROUTER_DATA_ROOT_DIR/emby/cache"
EMBY_DATA_EXTERNAL_DIRS=()
if [[ ! -z "$ARIA2_DATA_ROOT" ]] && [[ -e "$ARIA2_DATA_ROOT/download" ]]; then
  EMBY_DATA_EXTERNAL_DIRS=(${EMBY_DATA_EXTERNAL_DIRS[@]} "$ARIA2_DATA_ROOT/download:download")
fi

[ -e "/opt/podman" ] && export PATH="/opt/podman/bin:/opt/podman/libexec:$PATH"
export PATH="$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin"

"$@"
