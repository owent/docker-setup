[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ==============================================================================
# Squid 主进程
# ==============================================================================
# 说明:
#   - ufs/aufs 存储: 首次启动需要 squid -z 初始化目录结构 (/var/spool/squid/00)
#   - rock 存储: 无需 squid -z，主进程启动时自动创建数据库文件
# ==============================================================================
[program:squid]
command=/bin/bash -c "rm -f /var/run/squid.pid; if [ ! -e '/var/spool/squid/00' ] && [ ! -e '/var/spool/squid/rock' ]; then /usr/sbin/squid -z -f /etc/squid/squid.conf 2>/dev/null; sleep 2; fi; exec /usr/sbin/squid --foreground -f /etc/squid/squid.conf"
autostart=true
autorestart=true
startsecs=5
priority=20
# 日志输出到 stdout/stderr，让容器管理
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# ==============================================================================
# 日志轮转定时任务 (每小时检查一次，超过 30M 就轮转)
# ==============================================================================
[program:logrotate]
command=/bin/sh -c "while true; do sleep 3600; ACCESS_SIZE=`stat -c%%s /var/log/squid/access.log 2>/dev/null || echo 0`; CACHE_SIZE=`stat -c%%s /var/log/squid/cache.log 2>/dev/null || echo 0`; if [ $$ACCESS_SIZE -gt 31457280 ] || [ $$CACHE_SIZE -gt 31457280 ]; then /usr/sbin/squid -k rotate; echo \"`date`: Log rotated\"; fi; done"
autostart=true
autorestart=true
startsecs=0
priority=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
