# Squid 主配置文件 - Rock 存储 + 多 Worker 版本
# 
# 使用说明:
#   1. 复制此文件为 squid.conf
#   2. 清空缓存目录: rm -rf /var/spool/squid/*
#   3. 使用 --ipc=host 或 --shm-size=512m 启动容器
#
# 架构: 客户端 -> Caddy (HTTPS) -> Squid (HTTP) -> 源站 (HTTPS)
# Caddy 负责 SSL 终止，Squid 只处理 HTTP 反向代理缓存

# ==============================================================================
# 核心设置
# ==============================================================================
# 反向代理端口 (accel 模式) - Caddy 转发请求到此端口
http_port 0.0.0.0:3128 accel vhost allow-direct

# ==============================================================================
# 请求头处理 - 隐藏代理标识
# ==============================================================================
# 禁止 Squid 添加 Via 头
via off

# 删除 X-Forwarded-For 头
forwarded_for delete

# 禁止访问/修改以下请求头 (防止源站检测代理)
request_header_access X-Forwarded-For deny all
request_header_access X-Forwarded-Host deny all
request_header_access X-Forwarded-Server deny all
request_header_access Forwarded deny all
request_header_access Proxy-Connection deny all
request_header_access Surrogate-Capability deny all
request_header_access Cache-Control deny all


# ==============================================================================
# 访问控制
# ==============================================================================
# IPv4 内网网段
acl localnet src 10.0.0.0/8        # RFC 1918 Class A
acl localnet src 172.16.0.0/12     # RFC 1918 Class B
acl localnet src 192.168.0.0/16    # RFC 1918 Class C
acl localnet src 127.0.0.0/8       # Loopback
acl localnet src 169.254.0.0/16    # Link-local

# IPv6 内网网段
acl localnet src ::1/128           # Loopback
acl localnet src fe80::/10         # Link-local
acl localnet src fc00::/7          # Unique Local Address (ULA)

# 访问控制规则
http_access allow localnet
http_access deny all

# 指定DNS服务器，防止使用内网DNS导致回环
dns_nameservers 223.5.5.5 119.29.29.29

# ==============================================================================
# 超时 / 重试策略（适合不稳定上游）
# ==============================================================================
# 仅对幂等请求（如 GET/HEAD）进行失败重试
retry_on_error on

# 失败转发的最大尝试次数（包含首次请求），防止无限重试
forward_max_tries 3

# 建连超时（到源站）- 某些站点可能较慢，适当增加
connect_timeout 30 seconds

# peer 连接超时 - 控制 cache_peer 探测超时
peer_connect_timeout 15 seconds

# 单个请求的总超时（客户端下载大文件时建议偏大）
request_timeout 20 minutes

# 客户端连接最大生命周期（保证长下载不中断）
client_lifetime 4 hours

# ==============================================================================
# Cache Peer 全局配置
# ==============================================================================
# 禁用 peer 健康检查（避免误判 peer 为 DEAD）
# 说明: Squid 会定期探测 cache_peer，如果失败会标记为 DEAD
# 对于反向代理场景，我们希望每次请求都尝试连接源站，而不是预判
pconn_timeout 30 seconds

# ==============================================================================
# Rock 存储配置 (SMP 多 Worker)
# ==============================================================================
# Rock 是唯一支持 SMP 多 worker 共享磁盘缓存的存储类型
#
# 参数说明:
#   - 204800: 缓存大小 (MB)，约 200GB
#   - max-size=32768: 单个对象最大大小 (字节)，默认 512KB
#                     注意: IPC 页面大小限制为 32KB，更大的对象缓存效率降低
#   - swap-timeout=300: I/O 超时 (毫秒)，防止磁盘过载
#   - max-swap-rate=200: 每秒最大 I/O 操作数 (可选)
#                        普通 HDD: 100-200，SSD: 300+
#
# 容器要求:
#   - 需要 --ipc=host 或 --shm-size=512m
#   - /dev/shm 需要足够大
# ==============================================================================
cache_dir rock /var/spool/squid 204800 max-size=32768 swap-timeout=300

# 内存缓存配置
cache_mem 2048 MB
maximum_object_size 5 GB
maximum_object_size_in_memory 64 MB
range_offset_limit none

# SMP 共享内存缓存 (多 worker 必需)
memory_cache_shared on

# collapsed_forwarding 减少重复请求 (SMP 模式下有效)
collapsed_forwarding on

# ==============================================================================
# 多 Worker 配置
# ==============================================================================
# Rock 存储支持 SMP 多 worker 共享磁盘缓存
# 建议 worker 数 = CPU 核心数 - 1 (留一个给 disker)
#
# 进程结构 (workers=6 + 1 个 rock cache_dir):
#   - 1 个 coordinator (协调进程)
#   - 6 个 workers (处理请求)
#   - 1 个 disker (Rock 存储 I/O)
#   - 总共 8 个 Squid 进程
# ==============================================================================
workers 6

# ==============================================================================
# Store ID 重写程序
# ==============================================================================
store_id_program /opt/squid/script/store_id_rewriter.py
store_id_children 20 startup=2 idle=2 concurrency=20

# ==============================================================================
# 加载模块化配置
# ==============================================================================
include /etc/squid/conf.d/*.conf

# ==============================================================================
# 通用缓存规则 (放在最后作为兜底)
# ==============================================================================
refresh_pattern -i \.(zip|exe|msi|gz|tar|7z|rar|vsix|nupkg|cab|wim|esd)$ 10080 90% 43200

# ==============================================================================
# 日志配置
# ==============================================================================
#debug_options ALL,1 33,2 28,2
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
logfile_rotate 5
