# ============================================================================
# CMake 官方网站缓存配置
# ============================================================================
# 主要域名:
#   - cmake.org (CMake 官方站点)
#
# URL结构:
#   版本化下载 (可长期缓存):
#     - /files/v{major}.{minor}/cmake-{version}-{platform}.tar.gz
#     - /files/v{major}.{minor}/cmake-{version}-{platform}.zip
#     - /files/v{major}.{minor}/cmake-{version}-{platform}.msi
#     - /files/v{major}.{minor}/cmake-{version}-{platform}.dmg
#     - /files/v{major}.{minor}/cmake-{version}-{platform}.sh
#     - /files/v{major}.{minor}/cmake-{version}-SHA-256.txt
#   版本化文档 (可长期缓存):
#     - /cmake/help/v{version}/* (特定版本文档)
#   动态路径 (短期缓存):
#     - /download/ (下载页面)
#     - /documentation/ (文档首页)
#     - /files/ (目录列表)
#     - /files/dev/ (nightly builds)
#     - /cmake/help/latest/* (最新版文档，随发布更新)
#     - /cmake/help/git-master/* (开发版文档)
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义
# -----------------------------------------------------------------------------

# CMake 官方站点
acl cmake dstdomain cmake.org

# 版本化下载路径 - 可长期缓存
# 匹配: /files/v{major}.{minor}/cmake-{version}.* (不含目录)
acl cmake_versioned_download urlpath_regex ^/files/v[0-9]+\.[0-9]+/cmake-[0-9]+\.[0-9]+\.[0-9]+[^/]*\.(tar\.gz|zip|msi|dmg|sh|txt|asc|qch)$

# 版本化文档路径 - 可长期缓存
# 匹配: /cmake/help/v{version}/* (具体版本的文档)
acl cmake_versioned_docs urlpath_regex ^/cmake/help/v[0-9]+\.[0-9]+/

# latest/git-master 文档 - 中期缓存 (内容会随发布更新)
acl cmake_latest_docs urlpath_regex ^/cmake/help/(latest|git-master|git-stage)/

# 目录列表和动态页面 - 短期缓存
acl cmake_dynamic urlpath_regex ^/files/$
acl cmake_dynamic urlpath_regex ^/files/v[0-9]+\.[0-9]+/$
acl cmake_dynamic urlpath_regex ^/files/(LatestRelease|PreviousRelease|ReleaseCandidate|dev)/
acl cmake_dynamic urlpath_regex ^/download/?$
acl cmake_dynamic urlpath_regex ^/documentation/?$

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer cmake.org parent 443 0 no-query no-digest originserver name=peer_cmake tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制
# -----------------------------------------------------------------------------

cache_peer_access peer_cmake allow cmake
cache_peer_access peer_cmake deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow cmake

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

# 允许缓存 CMake
cache allow cmake

# -----------------------------------------------------------------------------
# Store ID 规则
# -----------------------------------------------------------------------------

# 版本化路径无需重写，URL本身就是稳定的
# 动态路径不适合store_id重写，保持原样以支持短期缓存
store_id_access allow cmake

# -----------------------------------------------------------------------------
# Refresh Pattern
# -----------------------------------------------------------------------------

# 版本化下载文件 - 永久缓存 (1年)
# cmake-{version}.tar.gz, .zip, .msi, .dmg, .sh, .txt (SHA-256), .asc (签名)
refresh_pattern -i cmake\.org/files/v[0-9]+\.[0-9]+/cmake-[0-9]+\.[0-9]+\.[0-9]+[^/]*\.(tar\.gz|zip|msi|dmg|sh|txt|asc|qch)$ 525600 100% 525600 override-expire ignore-no-store ignore-private ignore-must-revalidate

# 版本化文档 - 长期缓存 (30天)
# /cmake/help/v{version}/* - 特定版本文档不会变化
refresh_pattern -i cmake\.org/cmake/help/v[0-9]+\.[0-9]+/ 43200 100% 43200 override-expire ignore-no-store ignore-private ignore-must-revalidate

# latest/git-master 文档 - 中期缓存 (3天)
# 内容会随新版本发布而更新
refresh_pattern -i cmake\.org/cmake/help/(latest|git-master|git-stage)/ 4320 50% 10080 override-expire

# 目录列表和动态页面 - 短期缓存 (6小时)
refresh_pattern -i cmake\.org/(download|documentation|files)/?$ 360 50% 1440 override-expire

# 目录索引 - 短期缓存 (1天)
refresh_pattern -i cmake\.org/files/(LatestRelease|PreviousRelease|ReleaseCandidate|dev)/ 1440 50% 2880 override-expire
refresh_pattern -i cmake\.org/files/v[0-9]+\.[0-9]+/$ 1440 50% 2880 override-expire

# 静态资源 (CSS, JS, 图片) - 长期缓存 (7天)
refresh_pattern -i cmake\.org/.*\.(css|js|mjs|map|json|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot|wasm)$ 10080 90% 43200 override-expire ignore-no-store ignore-private
