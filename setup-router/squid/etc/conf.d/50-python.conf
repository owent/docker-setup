# ============================================================================
# Python PyPI 仓库缓存配置
# ============================================================================
# 主要域名:
#   - pypi.org (PyPI 主站)
#   - files.pythonhosted.org (包文件下载)
#   - pypi.python.org (旧域名，重定向到 pypi.org)
#
# URL结构:
#   包文件 (可长期缓存):
#     - files.pythonhosted.org/packages/xx/xx/xxxx/package-version.whl
#     - files.pythonhosted.org/packages/xx/xx/xxxx/package-version.tar.gz
#   元数据 (短期缓存):
#     - pypi.org/simple/package/ (包索引页)
#     - pypi.org/pypi/package/json (包元数据 JSON)
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义 - 每个域名单独 ACL 以正确路由
# -----------------------------------------------------------------------------

# PyPI 元数据/索引 - 单独 ACL
acl acl_pypi dstdomain pypi.org
acl acl_pypi_old dstdomain pypi.python.org

# 包文件下载
acl acl_pypi_files dstdomain files.pythonhosted.org

# 国内镜像 (可选)
acl pypi_tuna dstdomain pypi.tuna.tsinghua.edu.cn
acl pypi_aliyun dstdomain mirrors.aliyun.com
acl pypi_tencent dstdomain mirrors.cloud.tencent.com

# 合并ACL便于统一规则 (用于 store_id, cache, never_direct)
acl pypi_all dstdomain pypi.org
acl pypi_all dstdomain pypi.python.org
acl pypi_all dstdomain files.pythonhosted.org
acl pypi_all dstdomain pypi.tuna.tsinghua.edu.cn
acl pypi_all dstdomain mirrors.aliyun.com
acl pypi_all dstdomain mirrors.cloud.tencent.com

# 包文件路径 (whl, tar.gz, zip 等)
acl pypi_packages urlpath_regex /packages/.*\.(whl|tar\.gz|zip|egg)$

# 元数据路径
acl pypi_metadata urlpath_regex ^/simple/
acl pypi_metadata urlpath_regex ^/pypi/.*/json$

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer pypi.org parent 443 0 no-query no-digest originserver name=peer_pypi tls tls-default-ca=on
cache_peer pypi.python.org parent 443 0 no-query no-digest originserver name=peer_pypi_old tls tls-default-ca=on
cache_peer files.pythonhosted.org parent 443 0 no-query no-digest originserver name=peer_pypi_files tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# -----------------------------------------------------------------------------

cache_peer_access peer_pypi allow acl_pypi
cache_peer_access peer_pypi deny all

cache_peer_access peer_pypi_old allow acl_pypi_old
cache_peer_access peer_pypi_old deny all

cache_peer_access peer_pypi_files allow acl_pypi_files
cache_peer_access peer_pypi_files deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow pypi_all

# -----------------------------------------------------------------------------
# Store ID 访问控制
# -----------------------------------------------------------------------------

# 允许所有 PyPI 相关 URL 进行 store_id 重写
# 包括包文件和元数据页面
store_id_access allow pypi_all

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

cache allow pypi_all

# -----------------------------------------------------------------------------
# 刷新策略
# -----------------------------------------------------------------------------

# 包文件: 长期缓存 (版本号在文件名中，不会变)
# 30天 min, 365天 max
refresh_pattern -i files\.pythonhosted\.org/packages/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private

# 元数据: 中期缓存 (需要及时更新但不用太频繁)
# 改进缓存策略以处理 HTTP 304 响应:
# - ignore-no-cache: 忽略客户端的 no-cache 请求
# - ignore-must-revalidate: 忽略 must-revalidate 指令
# - ignore-private: 忽略 private 缓存控制
# - refresh-ims: 使用 If-Modified-Since 进行后台验证
# 6小时 min, 24小时 max (提高最小缓存时间以减少验证请求)
refresh_pattern -i pypi\.org/(simple/|pypi/.*/json) 360 50% 1440 ignore-no-cache ignore-must-revalidate ignore-private refresh-ims
refresh_pattern -i pypi\.python\.org/ 360 50% 1440 ignore-no-cache ignore-must-revalidate ignore-private refresh-ims
