# ============================================================================
# Node.js npm 仓库缓存配置
# ============================================================================
# 主要域名:
#   - registry.npmjs.org (npm 官方注册表)
#   - registry.npmmirror.com (淘宝镜像，原 registry.npm.taobao.org)
#   - registry.yarnpkg.com (Yarn 注册表，实际指向 npmjs)
#
# URL结构:
#   元数据 (短期缓存):
#     - registry.npmjs.org/package (包元数据 JSON)
#     - registry.npmjs.org/-/package/package-version.tgz (包文件)
#   包文件 (可长期缓存):
#     - registry.npmjs.org/package/-/package-version.tgz
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义 - 每个域名单独 ACL 以正确路由
# -----------------------------------------------------------------------------

# npm 官方注册表 - 单独 ACL
acl acl_npm dstdomain registry.npmjs.org

# Yarn 注册表
acl acl_yarn dstdomain registry.yarnpkg.com

# 淘宝镜像
acl acl_npmmirror dstdomain registry.npmmirror.com

# 合并ACL便于统一规则 (用于 store_id, cache, never_direct)
acl npm_all dstdomain registry.npmjs.org
acl npm_all dstdomain registry.yarnpkg.com
acl npm_all dstdomain registry.npmmirror.com

# 包文件路径 (.tgz 文件)
acl npm_tgz urlpath_regex /-/.*\.tgz$

# 元数据路径 (包信息 JSON)
acl npm_metadata urlpath_regex ^/[^/]+$

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer registry.npmjs.org parent 443 0 no-query no-digest originserver name=peer_npm tls tls-default-ca=on
cache_peer registry.yarnpkg.com parent 443 0 no-query no-digest originserver name=peer_yarn tls tls-default-ca=on
cache_peer registry.npmmirror.com parent 443 0 no-query no-digest originserver name=peer_npmmirror tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# -----------------------------------------------------------------------------

cache_peer_access peer_npm allow acl_npm
cache_peer_access peer_npm deny all

cache_peer_access peer_yarn allow acl_yarn
cache_peer_access peer_yarn deny all

cache_peer_access peer_npmmirror allow acl_npmmirror
cache_peer_access peer_npmmirror deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow npm_all

# -----------------------------------------------------------------------------
# Store ID 访问控制
# -----------------------------------------------------------------------------

# 包文件做 store_id 重写
store_id_access allow npm_all

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

cache allow npm_all

# -----------------------------------------------------------------------------
# 刷新策略
# -----------------------------------------------------------------------------

# 包文件 (.tgz): 长期缓存 (版本号在文件名中，不会变)
# 30天 min, 365天 max
refresh_pattern -i registry\.npmjs\.org/.*/-/.*\.tgz$ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i registry\.yarnpkg\.com/.*/-/.*\.tgz$ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i registry\.npmmirror\.com/.*/-/.*\.tgz$ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private

# 元数据: 中期缓存 (需要及时获取最新版本信息但不用太频繁)
# 1小时 min, 7天 max
refresh_pattern -i registry\.npmjs\.org/[^/]+$ 60 50% 10080
refresh_pattern -i registry\.yarnpkg\.com/[^/]+$ 60 50% 10080
refresh_pattern -i registry\.npmmirror\.com/[^/]+$ 60 50% 10080
