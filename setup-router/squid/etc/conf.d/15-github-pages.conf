# =============================================================================
# GitHub Pages / 静态站点缓存配置
# =============================================================================
# 目标:
# - 为 GitHub Pages 等静态站点增加可控的缓存策略
# - 静态资源 (js/css/font/image/wasm) 长缓存
# - 页面/索引 (html、无扩展名路径) 短缓存，避免站点更新延迟过久
# - Helm 仓库 index.yaml 短缓存；chart tgz 长缓存
#
# 适用域名:
#   - grafana.github.io
#   - charts.jenkins.io
#   - updates.jenkins.io
#   - get.jenkins.io
#   - openebs.github.io
#   - helm.goharbor.io
#   - opensearch-project.github.io
#   - git.rancher.io
#   - charts.rancher.io
#   - mirror.freedif.org
#   - mirror.ossplanet.net
# =============================================================================

# -----------------------------------------------------------------------------
# ACL 定义
# -----------------------------------------------------------------------------
acl acl_grafana_github_io dstdomain grafana.github.io
acl acl_charts_jenkins_io dstdomain charts.jenkins.io
acl acl_updates_jenkins_io dstdomain updates.jenkins.io
acl acl_get_jenkins_io dstdomain get.jenkins.io
acl acl_openebs_github_io dstdomain openebs.github.io
acl acl_helm_goharbor_io dstdomain helm.goharbor.io
acl acl_opensearch_project_github_io dstdomain opensearch-project.github.io
acl acl_git_rancher_io dstdomain git.rancher.io
acl acl_charts_rancher_io dstdomain charts.rancher.io
acl acl_mirror_freedif_org dstdomain mirror.freedif.org
acl acl_mirror_ossplanet_net dstdomain mirror.ossplanet.net

# 合并 ACL (用于 cache/never_direct)
acl static_sites dstdomain grafana.github.io
acl static_sites dstdomain charts.jenkins.io
acl static_sites dstdomain updates.jenkins.io
acl static_sites dstdomain get.jenkins.io
acl static_sites dstdomain openebs.github.io
acl static_sites dstdomain helm.goharbor.io
acl static_sites dstdomain opensearch-project.github.io
acl static_sites dstdomain git.rancher.io
acl static_sites dstdomain charts.rancher.io
acl static_sites dstdomain mirror.freedif.org
acl static_sites dstdomain mirror.ossplanet.net

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理到源站)
# -----------------------------------------------------------------------------
cache_peer grafana.github.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_grafana_github_io
cache_peer charts.jenkins.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_charts_jenkins_io
cache_peer updates.jenkins.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_updates_jenkins_io
cache_peer get.jenkins.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_get_jenkins_io
cache_peer openebs.github.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_openebs_github_io
cache_peer helm.goharbor.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_helm_goharbor_io
cache_peer opensearch-project.github.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_opensearch_project_github_io
cache_peer git.rancher.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_git_rancher_io
cache_peer charts.rancher.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_charts_rancher_io
cache_peer mirror.freedif.org parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_mirror_freedif_org
cache_peer mirror.ossplanet.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_mirror_ossplanet_net

# -----------------------------------------------------------------------------
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# -----------------------------------------------------------------------------
cache_peer_access peer_grafana_github_io allow acl_grafana_github_io
cache_peer_access peer_grafana_github_io deny all

cache_peer_access peer_charts_jenkins_io allow acl_charts_jenkins_io
cache_peer_access peer_charts_jenkins_io deny all

cache_peer_access peer_updates_jenkins_io allow acl_updates_jenkins_io
cache_peer_access peer_updates_jenkins_io deny all

cache_peer_access peer_get_jenkins_io allow acl_get_jenkins_io
cache_peer_access peer_get_jenkins_io deny all

cache_peer_access peer_openebs_github_io allow acl_openebs_github_io
cache_peer_access peer_openebs_github_io deny all

cache_peer_access peer_helm_goharbor_io allow acl_helm_goharbor_io
cache_peer_access peer_helm_goharbor_io deny all

cache_peer_access peer_opensearch_project_github_io allow acl_opensearch_project_github_io
cache_peer_access peer_opensearch_project_github_io deny all

cache_peer_access peer_git_rancher_io allow acl_git_rancher_io
cache_peer_access peer_git_rancher_io deny all

cache_peer_access peer_charts_rancher_io allow acl_charts_rancher_io
cache_peer_access peer_charts_rancher_io deny all

cache_peer_access peer_mirror_freedif_org allow acl_mirror_freedif_org
cache_peer_access peer_mirror_freedif_org deny all

cache_peer_access peer_mirror_ossplanet_net allow acl_mirror_ossplanet_net
cache_peer_access peer_mirror_ossplanet_net deny all

# -----------------------------------------------------------------------------
# 禁止直连，必须通过 cache_peer
# -----------------------------------------------------------------------------
never_direct allow static_sites

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------
cache allow static_sites

# -----------------------------------------------------------------------------
# Store ID 规则
# -----------------------------------------------------------------------------
# 仅对“静态资源/包文件”做 store_id 重写（移除 query），提高命中率。
# 不对 HTML/无扩展名路径生效，避免把不同 query 的页面错误合并。
acl static_sites_storeable urlpath_regex \/.*\.(css|js|mjs|map|json|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot|wasm|tgz|zip|gz|bz2|xz|zst|rpm|deb)$
store_id_access allow static_sites static_sites_storeable

# -----------------------------------------------------------------------------
# Refresh Pattern
# -----------------------------------------------------------------------------
# 说明:
# - override-expire/ignore-no-store 等用于“静态资源/版本化文件”，避免源站过度保守的缓存头影响命中率
# - HTML/目录/无扩展名路径采用短缓存，并启用 refresh-ims 以便后台验证

# 域名匹配组（为简化 refresh_pattern 书写）
# - *.github.io: GitHub Pages
# - *.jenkins.io: charts/updates/get
# - *.goharbor.io: helm.goharbor.io
# - *.rancher.io: git/charts
# 说明: refresh_pattern 只能写正则，Squid 不支持“变量”，所以这里用统一的分组表达式复用。

# Helm 仓库索引: index.yaml/index.yml
# - 比 HTML 稍“长”一点的缓存以降低拉取频率
# - refresh-ims 让 Squid 在后台使用 If-Modified-Since 验证
# 注意: Squid 使用 POSIX regex，不支持 (?:...) 这类非捕获分组
refresh_pattern -i ([^/]+\.github\.io|[^/]+\.jenkins\.io|[^/]+\.goharbor\.io|[^/]+\.rancher\.io|mirror\.freedif\.org|mirror\.ossplanet\.net)(/[^?]*/)*index\.ya?ml(\?.*)?$ 60 50% 2880 override-expire ignore-no-store ignore-private refresh-ims


# Helm chart 包: .tgz (通常带版本号，内容不可变，长缓存)
refresh_pattern -i ([^/]+\.github\.io|[^/]+\.jenkins\.io|[^/]+\.goharbor\.io|[^/]+\.rancher\.io|mirror\.freedif\.org|mirror\.ossplanet\.net)/.*\.tgz(\?.*)?$ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# 静态资源: js/css/font/image/wasm/json/map 等
# - 适当缩短，避免站点资源更新后等待过久
# 7天 min, 90天 max
refresh_pattern -i ([^/]+\.github\.io|[^/]+\.jenkins\.io|[^/]+\.goharbor\.io|[^/]+\.rancher\.io|mirror\.freedif\.org|mirror\.ossplanet\.net)/.*\.(css|js|mjs|map|json|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot|wasm)(\?.*)?$ 10080 100% 129600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# 版本化/发布类归档文件: (中-长缓存)
# 7天 min, 365天 max
refresh_pattern -i ([^/]+\.rancher\.io)/.*\.(zip|tgz|tar\.gz|tar\.xz|gz|bz2|xz|zst|rpm|deb)(\?.*)?$ 10080 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# HTML/目录/无扩展名路径: 缓存稍加长 (30分钟 min, 48小时 max)
# - GitHub Pages 常见无扩展名路由/目录落到这里
# - refresh-ims 用于后台验证，兼顾更新及时性
refresh_pattern -i ([^/]+\.github\.io|[^/]+\.jenkins\.io|[^/]+\.goharbor\.io|[^/]+\.rancher\.io|mirror\.freedif\.org|mirror\.ossplanet\.net)(/.*)?$ 60 50% 2880 override-expire ignore-no-store ignore-private refresh-ims
