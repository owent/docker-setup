# ============================================================================
# Golang Package Proxy 缓存配置
# ============================================================================
# 主要域名:
#   - proxy.golang.org (官方Go模块代理)
#   - sum.golang.org (校验和数据库)
#   - storage.googleapis.com (实际存储)
#
# URL结构:
#   版本化路径 (可长期缓存):
#     - /@v/v1.2.3.mod   - go.mod文件
#     - /@v/v1.2.3.zip   - 模块源码
#     - /@v/v1.2.3.info  - 版本元信息
#   动态路径 (短期缓存):
#     - /@v/list         - 版本列表
#     - /@latest         - 最新版本信息
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义
# -----------------------------------------------------------------------------

# Go模块代理
acl golang_proxy dstdomain proxy.golang.org
acl golang_sum dstdomain sum.golang.org

# 版本化路径 - 可长期缓存
acl golang_versioned urlpath_regex /@v/v[0-9]+\.[0-9]+\.[0-9]+[^/]*\.(mod|zip|info)$

# 动态路径 - 需要短期缓存
acl golang_dynamic urlpath_regex /@v/list$
acl golang_latest urlpath_regex /@latest$

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer proxy.golang.org parent 443 0 no-query originserver name=peer_golang_proxy tls tls-default-ca=on
cache_peer sum.golang.org parent 443 0 no-query originserver name=peer_golang_sum tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制
# -----------------------------------------------------------------------------

cache_peer_access peer_golang_proxy allow golang_proxy
cache_peer_access peer_golang_proxy deny all

cache_peer_access peer_golang_sum allow golang_sum
cache_peer_access peer_golang_sum deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow golang_proxy
never_direct allow golang_sum

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

# 允许缓存 Go 模块
cache allow golang_proxy
cache allow golang_sum

# -----------------------------------------------------------------------------
# Store ID 规则
# -----------------------------------------------------------------------------

# 版本化路径无需重写，URL本身就是稳定的
# 动态路径(@latest, list)不适合store_id重写，保持原样以支持短期缓存
store_id_access deny golang_proxy
store_id_access deny golang_sum

# -----------------------------------------------------------------------------
# Refresh Pattern
# -----------------------------------------------------------------------------

# 版本化的模块文件 - 永久缓存 (1年)
refresh_pattern -i ^https?://proxy\.golang\.org/.*/@v/v[0-9]+\.[0-9]+\.[0-9]+.*\.(mod|zip|info)$ 525600 100% 525600 override-expire ignore-no-store ignore-private

# 校验和数据 - 永久缓存
refresh_pattern -i ^https?://sum\.golang\.org/ 525600 100% 525600 override-expire ignore-no-store ignore-private

# 版本列表 - 短期缓存 (1小时)
refresh_pattern -i ^https?://proxy\.golang\.org/.*/@v/list$ 60 50% 60 override-expire

# @latest 查询 - 短期缓存 (10分钟)
refresh_pattern -i ^https?://proxy\.golang\.org/.*/@latest$ 10 50% 10 override-expire
