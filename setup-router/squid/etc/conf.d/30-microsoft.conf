# 微软下载缓存配置
# 包括: Windows Update, Visual Studio, VS Code, Office
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)
#
# 注意: 某些 API 端点参数会影响返回内容，需谨慎处理
# - update.code.visualstudio.com: 更新检查 API，不做 store_id 重写
# - api.nuget.org: API 查询，不做 store_id 重写

# =============================================================================
# ACL 定义
# =============================================================================
# 纯下载域名 (参数仅用于签名，可安全移除)
acl ms_downloads dstdomain download.microsoft.com
acl ms_downloads dstdomain download.windowsupdate.com
acl ms_downloads dstdomain dl.delivery.mp.microsoft.com
acl ms_downloads dstdomain download.visualstudio.microsoft.com
acl ms_downloads dstdomain download.visualstudio.com
acl ms_downloads dstdomain vscode.download.prss.microsoft.com
acl ms_downloads dstdomain globalcdn.nuget.org

# API / 动态查询域名 (参数影响内容，不做 store_id 重写)
acl ms_api dstdomain update.code.visualstudio.com
acl ms_api dstdomain api.nuget.org
acl ms_api dstdomain vsmarketplacebadges.dev

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer download.microsoft.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ms_dl
cache_peer download.windowsupdate.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ms_wu
cache_peer dl.delivery.mp.microsoft.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ms_delivery
cache_peer download.visualstudio.microsoft.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_vs_dl
cache_peer download.visualstudio.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_vs_dl2
cache_peer vscode.download.prss.microsoft.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_vscode_dl
cache_peer globalcdn.nuget.org parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_nuget

# API 域名
cache_peer update.code.visualstudio.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_vscode_update
cache_peer api.nuget.org parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_nuget_api
cache_peer vsmarketplacebadges.dev parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_vs_badges

# =============================================================================
# Cache Peer 访问控制
# =============================================================================
cache_peer_access peer_ms_dl allow ms_downloads
cache_peer_access peer_ms_wu allow ms_downloads
cache_peer_access peer_ms_delivery allow ms_downloads
cache_peer_access peer_vs_dl allow ms_downloads
cache_peer_access peer_vs_dl2 allow ms_downloads
cache_peer_access peer_vscode_dl allow ms_downloads
cache_peer_access peer_nuget allow ms_downloads
cache_peer_access peer_vscode_update allow ms_api
cache_peer_access peer_nuget_api allow ms_api
cache_peer_access peer_vs_market allow ms_api
cache_peer_access peer_vs_badges allow ms_api

# 禁止直连，必须通过 cache_peer
never_direct allow ms_downloads
never_direct allow ms_api

# =============================================================================
# Store ID 访问控制
# =============================================================================
# 只对下载域名做 store_id 重写
store_id_access allow ms_downloads
# ms_api 不做 store_id 重写

cache allow ms_downloads
cache allow ms_api

# =============================================================================
# 缓存策略
# =============================================================================

# 下载域名: 7天 min, 30天 max
refresh_pattern -i download\.microsoft\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i download\.windowsupdate\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i dl\.delivery\.mp\.microsoft\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i emdl\.ws\.microsoft\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i download\.visualstudio\.microsoft\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i download\.visualstudio\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i az764295\.vo\.msecnd\.net 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i vscode\.download\.prss\.microsoft\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private

# VS Code 扩展 (.vsix 文件): 7天 min, 30天 max
refresh_pattern -i gallery\.vsassets\.io/.*\.vsix 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private

# NuGet 包 (.nupkg 文件): 7天 min, 30天 max
refresh_pattern -i globalcdn\.nuget\.org 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private

# API 端点: 短缓存，遵循服务器响应
refresh_pattern -i update\.code\.visualstudio\.com 10 50% 60
refresh_pattern -i api\.nuget\.org 10 50% 60
