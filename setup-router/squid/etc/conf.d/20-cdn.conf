# 主流 CDN 缓存配置
# 注意: fonts.googleapis.com 的参数会影响内容，不在 store_id 中处理
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)

# =============================================================================
# ACL 定义
# =============================================================================
# 完全版本化的 CDN (版本号在路径中，可长期缓存)
acl cdn_versioned dstdomain cdnjs.cloudflare.com
acl cdn_versioned dstdomain cdn.staticfile.org
acl cdn_versioned dstdomain cdn.bootcdn.net
acl cdn_versioned dstdomain stackpath.bootstrapcdn.com
acl cdn_versioned dstdomain fonts.gstatic.com
acl cdn_versioned dstdomain ajax.googleapis.com

# 支持 @version 和 @latest 的 CDN (需区分处理)
acl cdn_npm dstdomain cdn.jsdelivr.net
acl cdn_npm dstdomain unpkg.com
acl cdn_npm dstdomain www.unpkg.com

# 参数影响内容的 CDN (不做 store_id 重写，依赖服务器缓存头)
acl cdn_dynamic dstdomain fonts.googleapis.com

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer cdnjs.cloudflare.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_cdnjs
cache_peer cdn.staticfile.org parent 443 0 no-query originserver tls tls-default-ca=on name=peer_staticfile
cache_peer cdn.bootcdn.net parent 443 0 no-query originserver tls tls-default-ca=on name=peer_bootcdn
cache_peer stackpath.bootstrapcdn.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_stackpath
cache_peer fonts.gstatic.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_gstatic
cache_peer ajax.googleapis.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_ajax
cache_peer cdn.jsdelivr.net parent 443 0 no-query originserver tls tls-default-ca=on name=peer_jsdelivr
cache_peer unpkg.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_unpkg
cache_peer fonts.googleapis.com parent 443 0 no-query originserver tls tls-default-ca=on name=peer_gfonts

# =============================================================================
# Cache Peer 访问控制
# =============================================================================
cache_peer_access peer_cdnjs allow cdn_versioned
cache_peer_access peer_staticfile allow cdn_versioned
cache_peer_access peer_bootcdn allow cdn_versioned
cache_peer_access peer_stackpath allow cdn_versioned
cache_peer_access peer_gstatic allow cdn_versioned
cache_peer_access peer_ajax allow cdn_versioned
cache_peer_access peer_jsdelivr allow cdn_npm
cache_peer_access peer_unpkg allow cdn_npm
cache_peer_access peer_gfonts allow cdn_dynamic

# 禁止直连，必须通过 cache_peer
never_direct allow cdn_versioned
never_direct allow cdn_npm
never_direct allow cdn_dynamic

# =============================================================================
# Store ID 访问控制
# =============================================================================
store_id_access allow cdn_versioned
store_id_access allow cdn_npm
# cdn_dynamic 不做 store_id 重写，因为参数影响内容

cache allow cdn_versioned
cache allow cdn_npm
cache allow cdn_dynamic

# =============================================================================
# 缓存策略
# =============================================================================

# 完全版本化的 CDN: 30天 min, 365天 max
refresh_pattern -i cdnjs\.cloudflare\.com/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i cdn\.staticfile\.org 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i cdn\.bootcdn\.net/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i stackpath\.bootstrapcdn\.com 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i fonts\.gstatic\.com 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i ajax\.googleapis\.com/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private

# npm CDN 带版本号的路径 (@x.y.z): 30天 min, 365天 max
refresh_pattern -i cdn\.jsdelivr\.net/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i unpkg\.com/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private

# npm CDN @latest 或无版本号: 短缓存 (1小时 min, 24小时 max)
refresh_pattern -i cdn\.jsdelivr\.net/.*@latest 60 50% 1440
refresh_pattern -i unpkg\.com/.*@latest 60 50% 1440
refresh_pattern -i cdn\.jsdelivr\.net/npm/[^@/]+/ 60 50% 1440
refresh_pattern -i unpkg\.com/[^@/]+/ 60 50% 1440

# fonts.googleapis.com: 较短缓存 (因为内容可能随参数变化)
refresh_pattern -i fonts\.googleapis\.com 1440 50% 10080
