# 主流 CDN 缓存配置
# 注意: fonts.googleapis.com 的参数会影响内容，不在 store_id 中处理
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)

# =============================================================================
# ACL 定义 - 每个域名单独 ACL 以正确路由到对应 cache_peer
# =============================================================================
acl acl_cdnjs dstdomain cdnjs.cloudflare.com
acl acl_staticfile dstdomain cdn.staticfile.org
acl acl_bootcdn dstdomain cdn.bootcdn.net
acl acl_stackpath dstdomain stackpath.bootstrapcdn.com
acl acl_gstatic dstdomain fonts.gstatic.com
acl acl_ajax dstdomain ajax.googleapis.com
acl acl_jsdelivr dstdomain cdn.jsdelivr.net
acl acl_unpkg dstdomain unpkg.com
acl acl_unpkg dstdomain www.unpkg.com
acl acl_gfonts dstdomain fonts.googleapis.com

# 合并的 ACL (用于 store_id 和 cache 控制)
acl cdn_versioned dstdomain cdnjs.cloudflare.com
acl cdn_versioned dstdomain cdn.staticfile.org
acl cdn_versioned dstdomain cdn.bootcdn.net
acl cdn_versioned dstdomain stackpath.bootstrapcdn.com
acl cdn_versioned dstdomain fonts.gstatic.com
acl cdn_versioned dstdomain ajax.googleapis.com

acl cdn_npm dstdomain cdn.jsdelivr.net
acl cdn_npm dstdomain unpkg.com
acl cdn_npm dstdomain www.unpkg.com

acl cdn_dynamic dstdomain fonts.googleapis.com

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer cdnjs.cloudflare.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_cdnjs
cache_peer cdn.staticfile.org parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_staticfile
cache_peer cdn.bootcdn.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_bootcdn
cache_peer stackpath.bootstrapcdn.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_stackpath
cache_peer fonts.gstatic.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_gstatic
cache_peer ajax.googleapis.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ajax
cache_peer cdn.jsdelivr.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_jsdelivr
cache_peer unpkg.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unpkg
cache_peer fonts.googleapis.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_gfonts

# =============================================================================
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# =============================================================================
cache_peer_access peer_cdnjs allow acl_cdnjs
cache_peer_access peer_cdnjs deny all
cache_peer_access peer_staticfile allow acl_staticfile
cache_peer_access peer_staticfile deny all
cache_peer_access peer_bootcdn allow acl_bootcdn
cache_peer_access peer_bootcdn deny all
cache_peer_access peer_stackpath allow acl_stackpath
cache_peer_access peer_stackpath deny all
cache_peer_access peer_gstatic allow acl_gstatic
cache_peer_access peer_gstatic deny all
cache_peer_access peer_ajax allow acl_ajax
cache_peer_access peer_ajax deny all
cache_peer_access peer_jsdelivr allow acl_jsdelivr
cache_peer_access peer_jsdelivr deny all
cache_peer_access peer_unpkg allow acl_unpkg
cache_peer_access peer_unpkg deny all
cache_peer_access peer_gfonts allow acl_gfonts
cache_peer_access peer_gfonts deny all

# 禁止直连，必须通过 cache_peer
never_direct allow cdn_versioned
never_direct allow cdn_npm
never_direct allow cdn_dynamic

# =============================================================================
# Store ID 访问控制
# =============================================================================
store_id_access allow cdn_versioned
store_id_access allow cdn_npm
# cdn_dynamic 不做 store_id 重写，因为参数影响内容

cache allow cdn_versioned
cache allow cdn_npm
cache allow cdn_dynamic

# =============================================================================
# 缓存策略
# =============================================================================

# 完全版本化的 CDN: 30天 min, 365天 max
refresh_pattern -i cdnjs\.cloudflare\.com/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i cdn\.staticfile\.org 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i cdn\.bootcdn\.net/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i stackpath\.bootstrapcdn\.com 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i fonts\.gstatic\.com 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i ajax\.googleapis\.com/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# npm CDN 带版本号的路径 (@x.y.z): 30天 min, 365天 max
refresh_pattern -i cdn\.jsdelivr\.net/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i unpkg\.com/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# npm CDN @latest 或无版本号: 短缓存 (1小时 min, 24小时 max)
# 添加 override-expire ignore-reload 防止源站返回不缓存头
refresh_pattern -i cdn\.jsdelivr\.net/.*@latest 60 50% 1440 override-expire ignore-reload
refresh_pattern -i unpkg\.com/.*@latest 60 50% 1440 override-expire ignore-reload
refresh_pattern -i cdn\.jsdelivr\.net/npm/[^@/]+/ 60 50% 1440 override-expire ignore-reload
refresh_pattern -i unpkg\.com/[^@/]+/ 60 50% 1440 override-expire ignore-reload

# fonts.googleapis.com: CSS 是动态生成的，根据 User-Agent 返回不同字体格式
# 每次请求内容可能不同，遵循源站缓存策略即可
# 真正的字体文件在 fonts.gstatic.com，那边会正常缓存
refresh_pattern -i fonts\.googleapis\.com 60 50% 1440
