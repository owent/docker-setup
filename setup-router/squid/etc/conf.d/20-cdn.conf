# 主流 CDN 缓存配置
# 注意: fonts.googleapis.com 的参数会影响内容，不在 store_id 中处理
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)

# =============================================================================
# ACL 定义 - 每个域名单独 ACL 以正确路由到对应 cache_peer
# =============================================================================
acl acl_cdnjs dstdomain cdnjs.cloudflare.com
acl acl_staticfile dstdomain cdn.staticfile.org
acl acl_bootcdn dstdomain cdn.bootcdn.net
acl acl_stackpath dstdomain stackpath.bootstrapcdn.com
acl acl_gstatic dstdomain fonts.gstatic.com
acl acl_ajax dstdomain ajax.googleapis.com
acl acl_jsdelivr dstdomain cdn.jsdelivr.net
acl acl_unpkg dstdomain unpkg.com
acl acl_unpkg dstdomain www.unpkg.com
acl acl_gfonts dstdomain fonts.googleapis.com

# ESM CDN / Web App
acl acl_esm_sh dstdomain esm.sh
acl acl_esm_run dstdomain esm.run
acl acl_skypack dstdomain cdn.skypack.dev
acl acl_ga_jspm_io dstdomain ga.jspm.io
acl acl_app_diagrams_net dstdomain app.diagrams.net
acl acl_viewer_diagrams_net dstdomain viewer.diagrams.net

# 合并的 ACL (用于 store_id 和 cache 控制)
acl cdn_versioned dstdomain cdnjs.cloudflare.com
acl cdn_versioned dstdomain cdn.staticfile.org
acl cdn_versioned dstdomain cdn.bootcdn.net
acl cdn_versioned dstdomain stackpath.bootstrapcdn.com
acl cdn_versioned dstdomain fonts.gstatic.com
acl cdn_versioned dstdomain ajax.googleapis.com

acl cdn_npm dstdomain cdn.jsdelivr.net
acl cdn_npm dstdomain unpkg.com
acl cdn_npm dstdomain www.unpkg.com

acl cdn_dynamic dstdomain fonts.googleapis.com

acl cdn_esm dstdomain esm.sh
acl cdn_esm dstdomain esm.run
acl cdn_esm dstdomain cdn.skypack.dev
acl cdn_esm dstdomain ga.jspm.io

# diagrams.net 为 Web App：允许缓存，但 store_id 仅对“静态资源后缀”生效（由 store_id_rewriter 的正则保证）
acl cdn_static_webapp dstdomain app.diagrams.net
acl cdn_static_webapp dstdomain viewer.diagrams.net

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer cdnjs.cloudflare.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_cdnjs
cache_peer cdn.staticfile.org parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_staticfile
cache_peer cdn.bootcdn.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_bootcdn
cache_peer stackpath.bootstrapcdn.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_stackpath
cache_peer fonts.gstatic.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_gstatic
cache_peer ajax.googleapis.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ajax
cache_peer cdn.jsdelivr.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_jsdelivr
cache_peer unpkg.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unpkg
cache_peer fonts.googleapis.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_gfonts

cache_peer esm.sh parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_esm_sh
cache_peer esm.run parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_esm_run
cache_peer cdn.skypack.dev parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_skypack
cache_peer ga.jspm.io parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_ga_jspm_io
cache_peer app.diagrams.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_app_diagrams_net
cache_peer viewer.diagrams.net parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_viewer_diagrams_net

# =============================================================================
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# =============================================================================
cache_peer_access peer_cdnjs allow acl_cdnjs
cache_peer_access peer_cdnjs deny all
cache_peer_access peer_staticfile allow acl_staticfile
cache_peer_access peer_staticfile deny all
cache_peer_access peer_bootcdn allow acl_bootcdn
cache_peer_access peer_bootcdn deny all
cache_peer_access peer_stackpath allow acl_stackpath
cache_peer_access peer_stackpath deny all
cache_peer_access peer_gstatic allow acl_gstatic
cache_peer_access peer_gstatic deny all
cache_peer_access peer_ajax allow acl_ajax
cache_peer_access peer_ajax deny all
cache_peer_access peer_jsdelivr allow acl_jsdelivr
cache_peer_access peer_jsdelivr deny all
cache_peer_access peer_unpkg allow acl_unpkg
cache_peer_access peer_unpkg deny all
cache_peer_access peer_gfonts allow acl_gfonts
cache_peer_access peer_gfonts deny all

cache_peer_access peer_esm_sh allow acl_esm_sh
cache_peer_access peer_esm_sh deny all
cache_peer_access peer_esm_run allow acl_esm_run
cache_peer_access peer_esm_run deny all
cache_peer_access peer_skypack allow acl_skypack
cache_peer_access peer_skypack deny all
cache_peer_access peer_ga_jspm_io allow acl_ga_jspm_io
cache_peer_access peer_ga_jspm_io deny all
cache_peer_access peer_app_diagrams_net allow acl_app_diagrams_net
cache_peer_access peer_app_diagrams_net deny all
cache_peer_access peer_viewer_diagrams_net allow acl_viewer_diagrams_net
cache_peer_access peer_viewer_diagrams_net deny all

# 禁止直连，必须通过 cache_peer
never_direct allow cdn_versioned
never_direct allow cdn_npm
never_direct allow cdn_dynamic
never_direct allow cdn_esm
never_direct allow cdn_static_webapp

# =============================================================================
# Store ID 访问控制
# =============================================================================
store_id_access allow cdn_versioned
store_id_access allow cdn_npm
# cdn_dynamic 不做 store_id 重写，因为参数影响内容
store_id_access allow cdn_static_webapp

cache allow cdn_versioned
cache allow cdn_npm
cache allow cdn_dynamic
cache allow cdn_esm
cache allow cdn_static_webapp

# =============================================================================
# 缓存策略
# =============================================================================

#+#+#+#+-----------------------------------------------------------------------
# 完全版本化/静态资源的 CDN: 30天 min, 365天 max
# 说明: 不需要对域名精确匹配；这里用更粗粒度的 host/path 组合匹配，减少规则数量。
refresh_pattern -i (cdnjs\.cloudflare\.com|cdn\.bootcdn\.net|ajax\.googleapis\.com)/ajax/libs/ 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i (cdn\.staticfile\.org|fonts\.gstatic\.com|stack(path|strap)\.[^/.]+) 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# npm CDN 带版本号的路径 (@x.y.z): 30天 min, 365天 max
refresh_pattern -i (cdn\.jsdelivr\.net|unpkg\.com|www\.unpkg\.com)/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# npm CDN @latest 或无版本号: 短缓存 (1小时 min, 24小时 max)
# 添加 override-expire ignore-reload 防止源站返回不缓存头
refresh_pattern -i (cdn\.jsdelivr\.net|unpkg\.com|www\.unpkg\.com)/.*@latest 60 50% 1440 override-expire ignore-reload
refresh_pattern -i (cdn\.jsdelivr\.net/npm/[^@/]+/|unpkg\.com/[^@/]+/|www\.unpkg\.com/[^@/]+/) 60 50% 1440 override-expire ignore-reload

# ESM CDN (esm.sh/esm.run/skypack/jspm)
# - 带显式版本号: 长缓存
# - 其它路径(含 @latest): 短缓存，避免内容漂移导致长时间拿到旧包
refresh_pattern -i (esm\.sh|esm\.run|cdn\.skypack\.dev|ga\.jspm\.io)/.*@[0-9] 43200 100% 525600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i (esm\.sh|esm\.run|cdn\.skypack\.dev|ga\.jspm\.io)/ 60 50% 1440 override-expire ignore-reload

# diagrams.net Web App
# - 静态资源: 中-长缓存（7天 min, 90天 max）
refresh_pattern -i \.diagrams\.net/.*\.(css|js|mjs|map|json|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot|wasm)(\?.*)?$ 10080 100% 129600 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
# - HTML/无扩展名/其它路径: 短缓存 + refresh-ims
refresh_pattern -i \.diagrams\.net(/.*)?$ 60 50% 1440 override-expire ignore-no-store ignore-private refresh-ims

# fonts.googleapis.com: CSS 是动态生成的，根据 User-Agent 返回不同字体格式
# 每次请求内容可能不同，遵循源站缓存策略即可
# 真正的字体文件在 fonts.gstatic.com，那边会正常缓存
refresh_pattern -i fonts\.googleapis\.com 60 50% 1440
