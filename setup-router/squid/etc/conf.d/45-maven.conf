# ============================================================================
# Java Maven 仓库缓存配置
# ============================================================================
# 主要域名:
#   - repo1.maven.org (Maven Central 主镜像)
#   - repo.maven.apache.org (Apache Maven 仓库)
#   - plugins.gradle.org (Gradle 插件仓库)
#   - jcenter.bintray.com (JCenter，已停止服务但可能还有请求)
#
# URL结构:
#   版本化路径 (可长期缓存):
#     - /maven2/group/artifact/version/artifact-version.jar
#     - /maven2/group/artifact/version/artifact-version.pom
#     - /maven2/group/artifact/version/artifact-version.jar.sha1
#   动态路径 (短期缓存):
#     - /maven2/group/artifact/maven-metadata.xml (版本列表)
#     - /maven2/group/artifact/maven-metadata.xml.sha1
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义
# -----------------------------------------------------------------------------

# Maven 仓库域名
acl maven_central dstdomain repo1.maven.org
acl maven_apache dstdomain repo.maven.apache.org
acl gradle_plugins dstdomain plugins.gradle.org

# 合并ACL便于统一规则
acl maven_repos dstdomain repo1.maven.org repo.maven.apache.org plugins.gradle.org

# 元数据文件 - 需要短期缓存
acl maven_metadata urlpath_regex /maven-metadata\.xml(\.sha1|\.md5)?$

# 版本化artifact - 包含版本号的路径
# 匹配: /group/artifact/1.2.3/artifact-1.2.3.jar 等
acl maven_versioned urlpath_regex /[0-9]+\.[0-9]+[^/]*/[^/]+\.(jar|pom|aar|war|zip|tar\.gz|sha1|md5|asc|module)$

# SNAPSHOT版本 - 需要短期缓存
# 使用 [-] 转义避免被解析为选项
acl maven_snapshot urlpath_regex [-]SNAPSHOT

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer repo1.maven.org parent 443 0 no-query no-digest originserver name=peer_maven_central tls tls-default-ca=on
cache_peer repo.maven.apache.org parent 443 0 no-query no-digest originserver name=peer_maven_apache tls tls-default-ca=on
cache_peer plugins.gradle.org parent 443 0 no-query no-digest originserver name=peer_gradle_plugins tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制
# -----------------------------------------------------------------------------

cache_peer_access peer_maven_central allow maven_central
cache_peer_access peer_maven_central deny all

cache_peer_access peer_maven_apache allow maven_apache
cache_peer_access peer_maven_apache deny all

cache_peer_access peer_gradle_plugins allow gradle_plugins
cache_peer_access peer_gradle_plugins deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow maven_central
never_direct allow maven_apache
never_direct allow gradle_plugins

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

# 允许缓存 Maven 仓库
cache allow maven_repos

# -----------------------------------------------------------------------------
# Store ID 规则
# -----------------------------------------------------------------------------

# Maven 仓库的URL已经是稳定的，无需store_id重写
store_id_access deny maven_repos

# -----------------------------------------------------------------------------
# Refresh Pattern
# -----------------------------------------------------------------------------

# SNAPSHOT版本 - 短期缓存 (30分钟)
refresh_pattern -i (repo1\.maven\.org|repo\.maven\.apache\.org|plugins\.gradle\.org)/.*[-]SNAPSHOT.* 30 50% 30 override-expire

# maven-metadata.xml - 短期缓存 (1小时)
refresh_pattern -i (repo1\.maven\.org|repo\.maven\.apache\.org|plugins\.gradle\.org)/.*/maven-metadata\.xml 60 50% 60 override-expire

# 版本化的artifact文件 - 长期缓存 (1年)
# .jar, .pom, .aar, .war 等
refresh_pattern -i repo1\.maven\.org/maven2/.*/[0-9]+\.[0-9]+[^/]*/[^/]+\.(jar|pom|aar|war|zip|module)$ 525600 100% 525600 override-expire ignore-no-store ignore-private ignore-must-revalidate

refresh_pattern -i (repo\.maven\.apache\.org|plugins\.gradle\.org)/.*/[0-9]+\.[0-9]+[^/]*/[^/]+\.(jar|pom|aar|war|zip|module)$ 525600 100% 525600 override-expire ignore-no-store ignore-private ignore-must-revalidate

# 校验和文件 - 长期缓存 (1年)
refresh_pattern -i (repo1\.maven\.org|repo\.maven\.apache\.org|plugins\.gradle\.org)/.*/[0-9]+\.[0-9]+[^/]*/[^/]+\.(sha1|md5|asc)$ 525600 100% 525600 override-expire ignore-no-store ignore-private ignore-must-revalidate

# Gradle插件标记文件 - 长期缓存
refresh_pattern -i plugins\.gradle\.org/m2/.*\.marker$ 525600 100% 525600 override-expire ignore-no-store ignore-private ignore-must-revalidate
