# ============================================================================
# C++ 文档网站缓存配置
# ============================================================================
# 主要域名:
#   - en.cppreference.com (C++ 标准库参考)
#   - cppreference.com (根域名)
#   - zh.cppreference.com (中文版)
#   - cplusplus.com (C++ 参考和教程)
#   - isocpp.org (ISO C++ 官方网站)
#   - www.boost.org (Boost 库文档)
#
# URL结构:
#   cppreference.com (MediaWiki):
#     - /w/cpp/... (C++ 文档)
#     - /w/c/... (C 文档)
#     - /mwiki/... (MediaWiki 静态资源)
#   cplusplus.com:
#     - /reference/... (标准库参考)
#     - /doc/... (教程)
#   boost.org:
#     - /doc/libs/{version}/... (版本化文档，长期缓存)
#     - /doc/libs/latest/... (最新版文档，中期缓存)
#     - /doc/libs/develop/... (开发版，短期缓存)
# ============================================================================

# -----------------------------------------------------------------------------
# ACL 定义
# -----------------------------------------------------------------------------

# cppreference.com 域名
acl cppreference dstdomain en.cppreference.com
acl cppreference dstdomain cppreference.com
acl cppreference dstdomain zh.cppreference.com

# cplusplus.com 域名
acl cplusplus dstdomain cplusplus.com
acl cplusplus dstdomain www.cplusplus.com

# isocpp.org 域名
acl isocpp dstdomain isocpp.org

# Boost 文档
acl boost_docs dstdomain www.boost.org
acl boost_docs dstdomain boost.org

# 合并 ACL
acl cppdocs_all dstdomain en.cppreference.com
acl cppdocs_all dstdomain cppreference.com
acl cppdocs_all dstdomain zh.cppreference.com
acl cppdocs_all dstdomain cplusplus.com
acl cppdocs_all dstdomain www.cplusplus.com
acl cppdocs_all dstdomain isocpp.org
acl cppdocs_all dstdomain www.boost.org
acl cppdocs_all dstdomain boost.org

# Boost 版本化文档路径 - 可长期缓存
# 匹配: /doc/libs/1_xx_x/...
acl boost_versioned_docs urlpath_regex ^/doc/libs/[0-9]+_[0-9]+_[0-9]+/

# Boost latest/release 文档 - 中期缓存
acl boost_latest_docs urlpath_regex ^/doc/libs/(latest|release)/

# Boost develop 文档 - 短期缓存
acl boost_develop_docs urlpath_regex ^/doc/libs/(develop|master)/

# -----------------------------------------------------------------------------
# Cache Peer 定义 (反向代理模式)
# -----------------------------------------------------------------------------

cache_peer en.cppreference.com parent 443 0 no-query no-digest originserver name=peer_cppreference_en tls tls-default-ca=on
cache_peer cppreference.com parent 443 0 no-query no-digest originserver name=peer_cppreference tls tls-default-ca=on
cache_peer zh.cppreference.com parent 443 0 no-query no-digest originserver name=peer_cppreference_zh tls tls-default-ca=on
cache_peer cplusplus.com parent 443 0 no-query no-digest originserver name=peer_cplusplus tls tls-default-ca=on
cache_peer www.cplusplus.com parent 443 0 no-query no-digest originserver name=peer_cplusplus_www tls tls-default-ca=on
cache_peer isocpp.org parent 443 0 no-query no-digest originserver name=peer_isocpp tls tls-default-ca=on
cache_peer www.boost.org parent 443 0 no-query no-digest originserver name=peer_boost_www tls tls-default-ca=on
cache_peer boost.org parent 443 0 no-query no-digest originserver name=peer_boost tls tls-default-ca=on

# -----------------------------------------------------------------------------
# Cache Peer 访问控制
# -----------------------------------------------------------------------------

cache_peer_access peer_cppreference_en allow cppreference
cache_peer_access peer_cppreference_en deny all

cache_peer_access peer_cppreference allow cppreference
cache_peer_access peer_cppreference deny all

cache_peer_access peer_cppreference_zh allow cppreference
cache_peer_access peer_cppreference_zh deny all

cache_peer_access peer_cplusplus allow cplusplus
cache_peer_access peer_cplusplus deny all

cache_peer_access peer_cplusplus_www allow cplusplus
cache_peer_access peer_cplusplus_www deny all

cache_peer_access peer_isocpp allow isocpp
cache_peer_access peer_isocpp deny all

cache_peer_access peer_boost_www allow boost_docs
cache_peer_access peer_boost_www deny all

cache_peer_access peer_boost allow boost_docs
cache_peer_access peer_boost deny all

# -----------------------------------------------------------------------------
# 禁止直接访问
# -----------------------------------------------------------------------------

never_direct allow cppreference
never_direct allow cplusplus
never_direct allow isocpp
never_direct allow boost_docs

# -----------------------------------------------------------------------------
# 缓存规则
# -----------------------------------------------------------------------------

cache allow cppdocs_all

# -----------------------------------------------------------------------------
# Store ID 规则
# -----------------------------------------------------------------------------

# 允许 store_id 重写以移除不必要的查询参数
store_id_access allow cppdocs_all

# -----------------------------------------------------------------------------
# Refresh Pattern
# -----------------------------------------------------------------------------

# cppreference.com - 文档页面 (中期缓存 3天)
# MediaWiki 页面会定期更新，但变化不频繁
refresh_pattern -i (en|zh)?\.?cppreference\.com/w/ 4320 50% 10080 override-expire

# cplusplus.com - 参考和教程 (中期缓存 3天)
refresh_pattern -i (www\.)?cplusplus\.com/(reference|doc)/ 4320 50% 10080 override-expire

# isocpp.org - 静态内容 (中期缓存 3天)
refresh_pattern -i isocpp\.org/(std|wiki|files)/ 4320 50% 10080 override-expire

# isocpp.org - 博客和动态内容 (短期缓存 6小时)
refresh_pattern -i isocpp\.org/blog/ 360 50% 1440 override-expire

# Boost 版本化文档 - 长期缓存 (30天)
# /doc/libs/1_xx_x/... - 特定版本文档不会变化
refresh_pattern -i (www\.)?boost\.org/doc/libs/[0-9]+_[0-9]+_[0-9]+/ 43200 100% 43200 override-expire ignore-no-store ignore-private ignore-must-revalidate

# Boost latest/release 文档 - 中期缓存 (3天)
refresh_pattern -i (www\.)?boost\.org/doc/libs/(latest|release)/ 4320 50% 10080 override-expire

# Boost develop 文档 - 短期缓存 (6小时)
refresh_pattern -i (www\.)?boost\.org/doc/libs/(develop|master)/ 360 50% 1440 override-expire

# 所有站点的静态资源 (CSS, JS, 图片) - 长期缓存 (7天)
refresh_pattern -i (cppreference\.com|cplusplus\.com|isocpp\.org|boost\.org)/.*\.(css|js|mjs|map|json|png|jpe?g|gif|webp|svg|ico|woff2?|ttf|eot|wasm)$ 10080 90% 43200 override-expire ignore-no-store ignore-private
