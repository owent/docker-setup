# Unity 下载缓存配置
# 包括: Unity Editor, Unity Hub, Package Manager
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)
#
# 注意: packages.unity.com 可能包含元数据 API 查询

# =============================================================================
# ACL 定义
# =============================================================================
# 纯下载域名 (可安全移除参数)
acl unity_downloads dstdomain download.unity3d.com
acl unity_downloads dstdomain beta.unity3d.com
acl unity_downloads dstdomain netstorage.unity3d.com
acl unity_downloads dstdomain public-cdn.cloud.unity3d.com

# API / 元数据域名 (可能需要保留参数)
acl unity_api dstdomain packages.unity.com

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer download.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_dl
cache_peer beta.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_beta
cache_peer netstorage.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_ns
cache_peer public-cdn.cloud.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_cdn
cache_peer packages.unity.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_pkg

# =============================================================================
# Cache Peer 访问控制
# =============================================================================
cache_peer_access peer_unity_dl allow unity_downloads
cache_peer_access peer_unity_beta allow unity_downloads
cache_peer_access peer_unity_ns allow unity_downloads
cache_peer_access peer_unity_cdn allow unity_downloads
cache_peer_access peer_unity_pkg allow unity_api

# 禁止直连，必须通过 cache_peer
never_direct allow unity_downloads
never_direct allow unity_api

# =============================================================================
# Store ID 访问控制
# =============================================================================
# 只对下载域名做 store_id 重写
store_id_access allow unity_downloads
# unity_api 不做 store_id 重写

cache allow unity_downloads
cache allow unity_api

# =============================================================================
# 缓存策略
# =============================================================================

# 下载域名: 7天 min, 30天 max
refresh_pattern -i download\.unity3d\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i download\.unity\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i beta\.unity3d\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i netstorage\.unity3d\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i public-cdn\.cloud\.unity3d\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i cdn-fastly\.unity3d\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i cdn\.unity\.cn 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i upm-cdn\.unity\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i assetstorev1-prd-cdn\.unity3dusercontent\.com 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private
refresh_pattern -i d2ujflorbtfzji\.cloudfront\.net 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private

# API 端点: 短缓存
refresh_pattern -i packages\.unity\.com 60 50% 1440