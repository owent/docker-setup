# Unity 下载缓存配置
# 包括: Unity Editor, Unity Hub, Package Manager
#
# 架构: Caddy (HTTPS) -> Squid (HTTP:3128) -> 源站 (HTTPS:443)
#
# 注意: packages.unity.com 可能包含元数据 API 查询

# =============================================================================
# ACL 定义 - 每个域名单独 ACL 以正确路由到对应 cache_peer
# =============================================================================
acl unity_dl dstdomain download.unity3d.com
acl unity_beta dstdomain beta.unity3d.com
acl unity_ns dstdomain netstorage.unity3d.com
acl unity_cdn dstdomain public-cdn.cloud.unity3d.com

# 合并的 ACL (用于 store_id 和 cache 控制)
acl unity_downloads dstdomain download.unity3d.com
acl unity_downloads dstdomain beta.unity3d.com
acl unity_downloads dstdomain netstorage.unity3d.com
acl unity_downloads dstdomain public-cdn.cloud.unity3d.com

# API / 元数据域名 (可能需要保留参数)
acl unity_pkg dstdomain packages.unity.com

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
cache_peer download.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_dl
cache_peer beta.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_beta
cache_peer netstorage.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_ns
cache_peer public-cdn.cloud.unity3d.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_cdn
cache_peer packages.unity.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_unity_pkg

# =============================================================================
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# =============================================================================
cache_peer_access peer_unity_dl allow unity_dl
cache_peer_access peer_unity_dl deny all
cache_peer_access peer_unity_beta allow unity_beta
cache_peer_access peer_unity_beta deny all
cache_peer_access peer_unity_ns allow unity_ns
cache_peer_access peer_unity_ns deny all
cache_peer_access peer_unity_cdn allow unity_cdn
cache_peer_access peer_unity_cdn deny all
cache_peer_access peer_unity_pkg allow unity_pkg
cache_peer_access peer_unity_pkg deny all

# 禁止直连，必须通过 cache_peer
never_direct allow unity_downloads
never_direct allow unity_pkg

# =============================================================================
# Store ID 访问控制
# =============================================================================
# 只对下载域名做 store_id 重写
store_id_access allow unity_downloads
# unity_pkg 不做 store_id 重写

cache allow unity_downloads
cache allow unity_pkg

# =============================================================================
# 缓存策略
# =============================================================================

# 下载域名: 7天 min, 30天 max
# ignore-must-revalidate: 忽略 Cache-Control: must-revalidate
# ignore-no-cache: 忽略 Cache-Control: no-cache (尝试强制缓存)
# store-stale: 验证时先返回过期缓存，后台更新
# 说明: refresh_pattern 是全局正则匹配；这里用“单标签子域名”通配替代 (a|b|c) 以减少分支，且避免匹配多级子域名。
refresh_pattern -i ([^/.]+\.unity3d\.com|public-cdn\.cloud\.unity3d\.com|cdn\.unity\.cn) 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate ignore-no-cache store-stale

# API 端点: 短缓存
refresh_pattern -i packages\.unity\.com 60 50% 1440