# GitHub 资产缓存配置
# 注意: 不缓存 raw.githubusercontent.com 以避免拉不到最新版本

# =============================================================================
# ACL 定义 - 每个域名单独 ACL 以正确路由到对应 cache_peer
# =============================================================================
acl acl_github_release dstdomain release-assets.githubusercontent.com
acl acl_github_objects dstdomain objects.githubusercontent.com
acl acl_github_codeload dstdomain codeload.github.com
acl acl_github_gist dstdomain gist.githubusercontent.com
acl acl_github_attach dstdomain user-attachments.githubusercontent.com

# 合并的 ACL (用于 store_id 和 cache 控制)
acl github_assets dstdomain release-assets.githubusercontent.com
acl github_assets dstdomain objects.githubusercontent.com
acl github_assets dstdomain codeload.github.com
acl github_assets dstdomain gist.githubusercontent.com
acl github_assets dstdomain user-attachments.githubusercontent.com

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
# tls: 启用 TLS 连接到后端
# tls-default-ca=on: 使用系统 CA 证书验证服务器
cache_peer release-assets.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_release
cache_peer objects.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_objects
cache_peer codeload.github.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_codeload
cache_peer gist.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_gist
cache_peer user-attachments.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_attach

# =============================================================================
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# =============================================================================
cache_peer_access peer_github_release allow acl_github_release
cache_peer_access peer_github_release deny all
cache_peer_access peer_github_objects allow acl_github_objects
cache_peer_access peer_github_objects deny all
cache_peer_access peer_github_codeload allow acl_github_codeload
cache_peer_access peer_github_codeload deny all
cache_peer_access peer_github_gist allow acl_github_gist
cache_peer_access peer_github_gist deny all
cache_peer_access peer_github_attach allow acl_github_attach
cache_peer_access peer_github_attach deny all

# 禁止直连，必须通过 cache_peer
never_direct allow github_assets

store_id_access allow github_assets
cache allow github_assets

# 缓存策略: 7天 min, 30天 max
# 说明: refresh_pattern 是全局正则匹配（不跟 ACL 绑定），用“单标签子域名”通配以减少大量 | 分支。
# - [^/.]+: 仅匹配一个域名标签（避免把多级子域名也吞进来）
refresh_pattern -i ([^/.]+\.githubusercontent\.com|codeload\.github\.com) 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
