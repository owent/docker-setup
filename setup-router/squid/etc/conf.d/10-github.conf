# GitHub 资产缓存配置
# 注意: raw.githubusercontent.com 默认采用“短缓存 + IMS 验证”以尽量保持最新；
#       对明确 commit id (sha1/sha256) 的 raw 内容可长缓存。

# =============================================================================
# ACL 定义 - 每个域名单独 ACL 以正确路由到对应 cache_peer
# =============================================================================
acl acl_github_release dstdomain release-assets.githubusercontent.com
acl acl_github_objects dstdomain objects.githubusercontent.com
acl acl_github_codeload dstdomain codeload.github.com
acl acl_github_gist dstdomain gist.githubusercontent.com
acl acl_github_attach dstdomain user-attachments.githubusercontent.com
acl acl_github_main dstdomain github.com
acl acl_github_raw dstdomain raw.githubusercontent.com

# 合并的 ACL (用于 store_id 和 cache 控制)
acl github_assets dstdomain release-assets.githubusercontent.com
acl github_assets dstdomain objects.githubusercontent.com
acl github_assets dstdomain codeload.github.com
acl github_assets dstdomain gist.githubusercontent.com
acl github_assets dstdomain user-attachments.githubusercontent.com

# GitHub 主站（注意：这里只做“代理”，缓存需额外按路径精确放行）
acl github_main dstdomain github.com

# GitHub Raw（通常用于拉取仓库文件/脚本）
acl github_raw dstdomain raw.githubusercontent.com

# raw 内容中，ref 段为明确 commit id 时内容不可变，可长缓存
# raw 格式: /<owner>/<repo>/<ref>/<path>
acl github_raw_immutable urlpath_regex ^/[^/]+/[^/]+/[0-9a-fA-F]{40,64}/

# GitHub 主站可缓存路径：release 下载与归档（通常内容不可变/带版本号）
# - releases/download: Release 附件下载入口（常见 302 -> release-assets）
# - archive: tag/branch 的归档下载入口（常见 302 -> codeload）
acl github_main_storeable urlpath_regex ^/[^/]+/[^/]+/(releases/download/|archive/)

# GitHub 主站可缓存页面：带明确 commit ID 的页面（内容不可变）
# 例:
#   - /<owner>/<repo>/tree/<sha>
#   - /<owner>/<repo>/commit/<sha>
# 备注:
#   - 目前 GitHub 主要是 40 位 hex (SHA-1)
#   - 为未来兼容，允许 40~64 位 hex（覆盖潜在 SHA-256 64 位）
acl github_main_sha_pages urlpath_regex ^/[^/]+/[^/]+/(tree|commit)/[0-9a-fA-F]{40,64}(/.*)?$

# Git over HTTPS (smart HTTP) 相关端点：禁止缓存以确保 git pull/fetch 总是最新
acl github_main_git_endpoints urlpath_regex -i \.git(/|$)|/info/refs$|/git-upload-pack$|/git-receive-pack$

# 若带 Cookie/鉴权，则认为内容可能与用户相关：禁止缓存，避免串号
acl github_main_has_cookie req_header Cookie
acl github_main_has_auth req_header Authorization

# =============================================================================
# Cache Peer 定义 (反向代理到源站)
# =============================================================================
# tls: 启用 TLS 连接到后端
# tls-default-ca=on: 使用系统 CA 证书验证服务器
cache_peer release-assets.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_release
cache_peer objects.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_objects
cache_peer codeload.github.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_codeload
cache_peer gist.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_gist
cache_peer user-attachments.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_attach
cache_peer github.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_main
cache_peer raw.githubusercontent.com parent 443 0 no-query no-digest originserver tls tls-default-ca=on name=peer_github_raw

# =============================================================================
# Cache Peer 访问控制 - 每个 peer 只允许对应的域名
# =============================================================================
cache_peer_access peer_github_release allow acl_github_release
cache_peer_access peer_github_release deny all
cache_peer_access peer_github_objects allow acl_github_objects
cache_peer_access peer_github_objects deny all
cache_peer_access peer_github_codeload allow acl_github_codeload
cache_peer_access peer_github_codeload deny all
cache_peer_access peer_github_gist allow acl_github_gist
cache_peer_access peer_github_gist deny all
cache_peer_access peer_github_attach allow acl_github_attach
cache_peer_access peer_github_attach deny all

cache_peer_access peer_github_main allow acl_github_main
cache_peer_access peer_github_main deny all

cache_peer_access peer_github_raw allow acl_github_raw
cache_peer_access peer_github_raw deny all

# 禁止直连，必须通过 cache_peer
never_direct allow github_assets
never_direct allow github_main
never_direct allow github_raw

store_id_access allow github_assets
store_id_access allow github_main github_main_storeable

# 缓存规则:
# - github_assets: 作为静态资源域名，允许缓存
# - github.com:
#   - git smart HTTP / 鉴权流量：禁止缓存
#   - release/archive 下载入口 & commit SHA 页面：允许缓存
#   - 其余页面：允许非常短期缓存 (refresh_pattern 控制)，并启用 refresh-ims 以尽量保持新鲜
cache allow github_assets
cache deny github_main github_main_git_endpoints
cache deny github_main github_main_has_cookie
cache deny github_main github_main_has_auth
cache allow github_main github_main_storeable
cache allow github_main github_main_sha_pages
cache allow github_main

# raw.githubusercontent.com:
# - 带 Cookie/Authorization 的请求：禁止缓存（可能是私有资源/用户态内容）
# - 默认短缓存 + IMS 验证，尽量保证“拉到最新”
# - ref 为 commit id 的内容：允许长缓存
cache deny github_raw github_main_has_cookie
cache deny github_raw github_main_has_auth
cache allow github_raw

# 缓存策略: 7天 min, 30天 max
# 说明: refresh_pattern 是全局正则匹配（不跟 ACL 绑定），用“单标签子域名”通配以减少大量 | 分支。
# - [^/.]+: 仅匹配一个域名标签（避免把多级子域名也吞进来）
refresh_pattern -i ([^/.]+\.githubusercontent\.com|codeload\.github\.com) 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# GitHub 主站：仅对白名单下载入口做长缓存
# 备注：实际文件一般会跳转到 release-assets/codeload，本规则主要用于缓存跳转响应与少量直出下载。
refresh_pattern -i github\.com/[^/]+/[^/]+/releases/download/ 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate
refresh_pattern -i github\.com/[^/]+/[^/]+/archive/ 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# GitHub 主站：明确 commit ID 的页面可长缓存（但不做 store_id 重写，保留 query 以区分不同视图）
refresh_pattern -i github\.com/[^/]+/[^/]+/(tree|commit)/[0-9a-fA-F]{40,64} 10080 100% 43200 ignore-private refresh-ims

# GitHub 主站：其余页面启用非常短期缓存（主要降低重复访问压力，并通过 IMS 保持新鲜）
# 注意：不启用 ignore-no-store/ignore-must-revalidate，尽量尊重源站的“不可缓存”响应
refresh_pattern -i github\.com/ 3 20% 30 ignore-private refresh-ims

# raw.githubusercontent.com 缓存策略
# - commit id 的 raw 内容：长缓存（内容不可变）
refresh_pattern -i raw\.githubusercontent\.com/[^/]+/[^/]+/[0-9a-fA-F]{40,64}/ 10080 100% 43200 override-expire ignore-reload ignore-no-store ignore-private ignore-must-revalidate

# - 其余 raw：短缓存 + IMS 验证，尽量保持最新
refresh_pattern -i raw\.githubusercontent\.com/ 3 20% 30 ignore-private refresh-ims
