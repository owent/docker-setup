# Squid 主配置文件
# 使用 include 加载模块化配置
#
# 架构: 客户端 -> Caddy (HTTPS) -> Squid (HTTP) -> 源站 (HTTPS)
# Caddy 负责 SSL 终止，Squid 只处理 HTTP 反向代理缓存

# ==============================================================================
# 核心设置
# ==============================================================================
# 反向代理端口 (accel 模式) - Caddy 转发请求到此端口
http_port 0.0.0.0:3128 accel vhost allow-direct

# ==============================================================================
# 请求头处理 - 隐藏代理标识
# ==============================================================================
# 禁止 Squid 添加 Via 头
via off

# 删除 X-Forwarded-For 头
forwarded_for delete

# 禁止访问/修改以下请求头 (防止源站检测代理)
request_header_access X-Forwarded-For deny all
request_header_access X-Forwarded-Host deny all
request_header_access X-Forwarded-Server deny all
request_header_access Forwarded deny all
request_header_access Proxy-Connection deny all
request_header_access Surrogate-Capability deny all
request_header_access Cache-Control deny all


# ==============================================================================
# 访问控制
# ==============================================================================
# IPv4 内网网段
acl localnet src 10.0.0.0/8        # RFC 1918 Class A
acl localnet src 172.16.0.0/12     # RFC 1918 Class B
acl localnet src 192.168.0.0/16    # RFC 1918 Class C
acl localnet src 127.0.0.0/8       # Loopback
acl localnet src 169.254.0.0/16    # Link-local

# IPv6 内网网段
acl localnet src ::1/128           # Loopback
acl localnet src fe80::/10         # Link-local
acl localnet src fc00::/7          # Unique Local Address (ULA)

# 访问控制规则
http_access allow localnet
http_access deny all

# 指定DNS服务器，防止使用内网DNS导致回环
dns_nameservers 223.5.5.5 119.29.29.29

# ==============================================================================
# 超时 / 重试策略（适合不稳定上游）
# ==============================================================================
# 仅对幂等请求（如 GET/HEAD）进行失败重试
retry_on_error on

# 失败转发的最大尝试次数（包含首次请求），防止无限重试
forward_max_tries 3

# 建连超时（到源站）
connect_timeout 20 seconds

# 单个请求的总超时（客户端下载大文件时建议偏大）
request_timeout 20 minutes

# 客户端连接最大生命周期（保证长下载不中断）
client_lifetime 4 hours

# ==============================================================================
# 缓存参数
# ==============================================================================
cache_dir ufs /var/spool/squid 204800 32 256
cache_mem 2048 MB
maximum_object_size 5 GB
maximum_object_size_in_memory 64 MB
range_offset_limit none
collapsed_forwarding on

# 允许返回过期缓存的时间窗口 (秒)
# 在此时间内，即使缓存过期也直接返回，后台异步验证
# 设置为 0 禁用此功能
refresh_stale_hit 86400 seconds

# ==============================================================================
# Store ID 重写程序
# ==============================================================================
store_id_program /opt/squid/script/store_id_rewriter.py
store_id_children 10 startup=2 idle=2 concurrency=10

# ==============================================================================
# 加载模块化配置
# ==============================================================================
include /etc/squid/conf.d/*.conf

# ==============================================================================
# 通用缓存规则 (放在最后作为兜底)
# ==============================================================================
refresh_pattern -i \.(zip|exe|msi|gz|tar|7z|rar|vsix|nupkg|cab|wim|esd)$ 10080 90% 43200

# ==============================================================================
# 日志配置
# ==============================================================================
#debug_options ALL,1 33,2 28,2
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
logfile_rotate 5
