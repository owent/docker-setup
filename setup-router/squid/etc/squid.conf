# Squid 主配置文件
# 使用 include 加载模块化配置
#
# 架构: 客户端 -> Caddy (HTTPS) -> Squid (HTTP) -> 源站 (HTTPS)
# Caddy 负责 SSL 终止，Squid 只处理 HTTP 反向代理缓存

# ==============================================================================
# 核心设置
# ==============================================================================
# 反向代理端口 (accel 模式) - Caddy 转发请求到此端口
http_port 0.0.0.0:3128 accel vhost allow-direct

# ==============================================================================
# 访问控制
# ==============================================================================
# IPv4 内网网段
acl localnet src 10.0.0.0/8        # RFC 1918 Class A
acl localnet src 172.16.0.0/12     # RFC 1918 Class B
acl localnet src 192.168.0.0/16    # RFC 1918 Class C
acl localnet src 127.0.0.0/8       # Loopback
acl localnet src 169.254.0.0/16    # Link-local

# IPv6 内网网段
acl localnet src ::1/128           # Loopback
acl localnet src fe80::/10         # Link-local
acl localnet src fc00::/7          # Unique Local Address (ULA)

# 访问控制规则
http_access allow localnet
http_access deny all

# 指定DNS服务器，防止使用内网DNS导致回环
dns_nameservers 223.5.5.5 119.29.29.29

# ==============================================================================
# 缓存参数
# ==============================================================================
cache_dir ufs /var/spool/squid 204800 32 256
cache_mem 2048 MB
maximum_object_size 5 GB
maximum_object_size_in_memory 64 MB
range_offset_limit none
collapsed_forwarding on

# ==============================================================================
# Store ID 重写程序
# ==============================================================================
store_id_program /opt/squid/script/store_id_rewriter.py
store_id_children 10 startup=2 idle=2 concurrency=10

# ==============================================================================
# 加载模块化配置
# ==============================================================================
include /etc/squid/conf.d/*.conf

# ==============================================================================
# 通用缓存规则 (放在最后作为兜底)
# ==============================================================================
refresh_pattern -i \.(zip|exe|msi|gz|tar|7z|rar|vsix|nupkg|cab|wim|esd)$ 10080 90% 43200

# ==============================================================================
# 日志配置
# ==============================================================================
#debug_options ALL,1 33,2 28,2
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log