# ===== nf_conntrack 容量配置 =====
# 允许最多 200 万个连接（16G 机器较安全的起点）
# 运行过程中，nf_conntrack_count / nf_conntrack_max 最好长期低于 60–70%。
# 查询是否有丢包/表满 journalctl -k --since="2 days ago" -g "nf_conntrack: table full"
# 估算：
# - 单条 conntrack 约占 320–500 字节（不同内核版本略有不同）
# - 粗略算：1GB 内存 ≈ 200万–300万条连接的上限（只算 conntrack，不含系统其它消耗）
# 企业中等负载网关常见配置（仅供参考）：
# - 8G 内存：nf_conntrack_max 1,000,000～2,000,000
# - 16G 内存：nf_conntrack_max 2,000,000～4,000,000
# - 32G+ 内存：nf_conntrack_max 4,000,000 以上（看业务）
# 后续可通过 sudo ss -s 和 cat /proc/sys/net/netfilter/nf_conntrack_count 看统计数据调优
net.netfilter.nf_conntrack_max = 2097152

# 哈希桶，通常 nf_conntrack_max / 4
net.netfilter.nf_conntrack_buckets = 524288

# ===== TCP 超时时间优化 =====
# 已建立连接，30 分钟没流量就回收
net.netfilter.nf_conntrack_tcp_timeout_established = 1800

# 关闭相关状态，加快回收
# net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
# net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
# net.netfilter.nf_conntrack_tcp_timeout_time_wait = 60
# net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30

# SYN 相关，防止半连接占资源
# net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60
# net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120

# ===== UDP / 其他协议 =====
# 普通短 UDP（DNS/查询），93-vbox.conf 里有设置，注意不要冲突
net.netfilter.nf_conntrack_udp_timeout = 60

# 持续 UDP 流（某些隧道/流媒体），93-vbox.conf 里有设置，注意不要冲突， sing-box里推荐大于 udp_timeout 的值
net.netfilter.nf_conntrack_udp_timeout_stream = 600

# 其他协议的通用超时
net.netfilter.nf_conntrack_generic_timeout = 120

# ===== 其它设置 =====
# TCP 宽松模式，一般保持 1，避免连接跟踪异常
net.netfilter.nf_conntrack_tcp_loose = 1

# 关闭流量计数以提升性能（如需基于 conntrack 做统计则设 1）
# 需要用 conntrack -L 看精确流量就保持 1。
net.netfilter.nf_conntrack_acct = 0

# 保持 checksum 校验，提升安全性
net.netfilter.nf_conntrack_checksum = 1