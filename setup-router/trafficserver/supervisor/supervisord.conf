[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ==============================================================================
# Apache Traffic Server 主进程
# ==============================================================================
# traffic_server 是多线程架构，原生支持高并发
# ==============================================================================
[program:trafficserver]
command=/bin/bash -c "mkdir -p /var/log/trafficserver /var/run/trafficserver /var/cache/trafficserver; chown -R trafficserver:trafficserver /var/log/trafficserver /var/run/trafficserver /var/cache/trafficserver; chmod 775 /var/log/trafficserver /var/run/trafficserver /var/cache/trafficserver; rm -f /var/run/trafficserver/*.lock /var/run/trafficserver/*.sock 2>/dev/null; exec /usr/bin/traffic_server"
autostart=true
autorestart=true
startsecs=5
priority=20
# 日志输出到 stdout/stderr
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# ==============================================================================
# Traffic Manager (已禁用,由 supervisord 管理 traffic_server 即可)
# ==============================================================================
# [program:traffic_manager]
# command=/usr/bin/traffic_manager
# autostart=true
# autorestart=true
# startsecs=3
# priority=10
# stdout_logfile=/dev/stdout
# stdout_logfile_maxbytes=0
# stderr_logfile=/dev/stderr
# stderr_logfile_maxbytes=0

# ==============================================================================
# 日志轮转定时任务
# ==============================================================================
[program:logrotate]
command=/bin/sh -c "while true; do sleep 3600; find /var/log/trafficserver -name '*.old' -mtime +7 -delete 2>/dev/null; echo \"`date`: Log cleanup done\"; done"
autostart=true
autorestart=true
startsecs=0
priority=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
