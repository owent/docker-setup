# Apache Traffic Server 10.x 主配置文件
#
# 架构: 客户端 -> Caddy (HTTPS:443) -> ATS (HTTP:3126) -> 源站 (HTTPS:443)
# Caddy 负责 SSL 终止，ATS 只处理 HTTP 反向代理缓存
#
# 配置文件说明:
#   - records.yaml: 主配置文件 (本文件)
#   - remap.config: URL 重映射规则 (必需, 定义域名到源站的映射)
#   - cache.config: 缓存策略
#   - hosting.config: 缓存分区
#   - storage.config: 存储配置

# ==============================================================================
# ATS 10.x 使用嵌套 YAML 结构
# proxy.config.xxx.yyy.zzz 变为 xxx: yyy: zzz:
# ==============================================================================
records:
  # ==============================================================================
  # 基础配置
  # ==============================================================================
  # 代理模式: 反向代理 (Caddy -> ATS -> 源站)
  reverse_proxy:
    enabled: 1

  url_remap:
    remap_required: 1

  # 监听端口 (HTTP only, Caddy 处理 HTTPS)
  http:
    server_ports: "3126"

    # Keep-Alive 配置
    keep_alive_enabled_in: 1
    keep_alive_enabled_out: 1
    keep_alive_no_activity_timeout_in: 60
    keep_alive_no_activity_timeout_out: 60

    # 连接超时
    connect_attempts_timeout: 30
    transaction_no_activity_timeout_in: 120
    transaction_no_activity_timeout_out: 120

    # 重试配置
    connect_attempts_max_retries: 3
    connect_attempts_rr_retries: 2

    # 请求头处理 - 隐藏代理标识
    # 不添加 Via 头
    insert_request_via_str: 0
    insert_response_via_str: 0

    # 不添加 Forwarded 头 (none = 禁用)
    # 可选值: none, for, by, proto, host (可用 | 组合)
    insert_forwarded: none

    # Accept-Encoding 标准化 (请求源站时的压缩支持)
    # 0 = 不修改 Accept-Encoding
    # 1 = 标准化为 gzip, deflate
    # 2 = 标准化为 br, gzip, deflate (包含 Brotli)
    normalize_ae: 2

    # 删除可能暴露代理的头
    anonymize_remove_from: 1
    anonymize_remove_referer: 0
    anonymize_remove_user_agent: 0
    anonymize_remove_cookie: 0
    anonymize_remove_client_ip: 1

    # 缓存配置
    cache:
      http: 1

      # ==============================================================================
      # 启发式缓存 (Heuristic Caching)
      # 当响应没有 Cache-Control/Expires 但有 Last-Modified 时，自动计算缓存时间
      # ==============================================================================
      # required_headers 决定何时可以缓存响应:
      #   0 = 必须有 Cache-Control 或 Expires (默认，最严格)
      #   1 = 必须有 Last-Modified 或 Cache-Control 或 Expires
      #   2 = 只要有以上任意头就可以缓存
      required_headers: 1

      # 启发式缓存时间计算: 缓存时间 = (当前时间 - Last-Modified) * lm_factor
      # 例如: 文件3天前修改, lm_factor=0.1, 缓存时间 = 3天 * 0.1 = 7.2小时
      heuristic_lm_factor: 0.1
      # 启发式缓存最小/最大时间 (秒)
      heuristic_min_lifetime: 3600 # 最少1小时
      heuristic_max_lifetime: 604800 # 最多7天

      # ==============================================================================
      # 忽略缓存控制头 (强制缓存)
      # ==============================================================================
      # 忽略客户端请求中的 Cache-Control/Pragma: no-cache
      ignore_client_no_cache: 1
      ignore_client_cc_max_age: 1
      ims_on_client_no_cache: 0 # 不因客户端 no-cache 发送条件请求

      # 忽略服务端响应中的 Cache-Control: no-cache/no-store/private
      # 注意: 这会强制缓存所有响应，即使源站明确禁止
      ignore_server_no_cache: 1

      # 设置默认缓存时间 (当没有任何缓存头时)
      # never_cache_hdr: 0              # 默认0，允许缓存无缓存头的响应

      # ==============================================================================
      # 缓存键标准化 (Cache Key Normalization)
      # ==============================================================================
      # 忽略 Vary 头相关的差异，简化缓存 key
      ignore_accept_mismatch: 1
      ignore_accept_language_mismatch: 1
      ignore_accept_charset_mismatch: 1
      ignore_accept_encoding_mismatch: 1

      # 缓存认证响应 (对于需要Cookie的响应)
      cache_responses_to_cookies: 1

      # ==============================================================================
      # 缓存重定向响应 (3xx)
      # ==============================================================================
      # 允许缓存 301/302/303/307/308 重定向
      # 对于稳定的下载链接 (如 GitHub releases)，缓存重定向可显著提升性能
      # ATS 10.x 默认会缓存 3xx 响应（如果响应头允许）
      # 这里通过 header_rewrite 为特定路径添加 Cache-Control

    # 源站连接失败时的行为
    parent_proxy:
      retry_time: 30
      fail_threshold: 3

  # 运行用户
  admin:
    user_id: trafficserver

  # ==============================================================================
  # 高并发配置
  # ==============================================================================
  exec_thread:
    # 启用自动配置线程数 (基于 CPU 核心数)
    autoconfig:
      enabled: 1
      # 线程数 = CPU核心数 * scale，scale=1.5 表示 8核=12线程
      scale: 1.5
    # 限制最大线程数为 16 (适用于 8核及以上 CPU)
    limit: 16

  # 接受线程数 (建议为 2-4)
  accept_threads: 2

  # 任务线程数 (异步任务处理)
  task_threads: 8

  # ==============================================================================
  # 连接配置 (支持2000000连接)
  # ==============================================================================
  net:
    # 最大客户端连接数
    connections_throttle: 2000000

  # ==============================================================================
  # 缓存配置
  # ==============================================================================
  cache:
    # 内存缓存大小 (2GB)
    ram_cache:
      size: 2G
    # 磁盘缓存启用
    enable_read_while_writer: 1

  # ==============================================================================
  # 调试配置 (诊断缓存问题后可关闭)
  # ==============================================================================
  diags:
    debug:
      enabled: 1
      tags: "http_hdrs|http_trans|cache"

  # ==============================================================================
  # 日志配置
  # ==============================================================================
  log:
    logging_enabled: 3
    max_space_mb_for_logs: 2048
    rolling_enabled: 1
    rolling_interval_sec: 86400
    rolling_size_mb: 200
    auto_delete_rolled_files: 1

  # ==============================================================================
  # 错误页面模板
  # ==============================================================================
  body_factory:
    template_sets_dir: /usr/share/trafficserver/body_factory

  # ==============================================================================
  # DNS 配置
  # ==============================================================================
  dns:
    nameservers: "223.5.5.5 119.29.29.29"
    resolv_conf: "NULL"

  # ==============================================================================
  # SSL/TLS 配置 (连接源站)
  # ==============================================================================
  ssl:
    # CA 证书文件路径 (Debian)
    client:
      CA:
        cert:
          filename: /etc/ssl/certs/ca-certificates.crt
      # 启用证书验证
      verify:
        server:
          policy: ENFORCED
