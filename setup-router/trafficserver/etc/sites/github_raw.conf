# raw.githubusercontent.com 缓存策略
#
# Raw 格式: /<owner>/<repo>/<ref>/<path>
# - ref 为 commit id (40-64位 hex) 时：内容不可变，可长缓存
# - ref 为 branch/tag 时：内容可能变化，短缓存 + IMS 验证
#
# ATS header_rewrite 语法:
#   条件: cond %{CLIENT-URL:PATH} /regex/
#   操作: set-header <name> <value>

# ==============================================================================
# 阶段1: REMAP 阶段 - 启用缓存配置
# ==============================================================================
cond %{CLIENT-URL:PATH} /\/[^\/]+\/[^\/]+\/[0-9a-fA-F]{40,64}\//
  # 重新启用缓存 (覆盖 bypass_auth.conf 的禁用)
  set-config proxy.config.http.cache.http 1
  set-config proxy.config.http.cache.cache_responses_to_cookies 1

# ==============================================================================
# 阶段2: READ_RESPONSE_HDR_HOOK - 修改响应头添加 Cache-Control
# ==============================================================================
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/[^\/]+\/[^\/]+\/[0-9a-fA-F]{40,64}\//
  set-header Cache-Control "public, max-age=604800"
