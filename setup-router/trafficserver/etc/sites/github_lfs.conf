# GitHub LFS 缓存策略
# LFS 对象按 SHA-256 哈希寻址，内容不可变，可长期缓存
# LFS API 端点（locks, batch 等）必须禁止缓存
#
# ATS header_rewrite 语法:
#   条件: cond %{CLIENT-URL:PATH} /regex/
#   操作: set-header <name> <value>
#
# LFS 端点分析:
#   /objects/:oid       - 对象下载 (SHA-256 内容寻址，不可变) -> 长缓存
#   /objects/batch      - 批量请求 API -> 禁止缓存
#   /locks              - 锁管理 API -> 禁止缓存
#   /locks/verify       - 锁验证 API -> 禁止缓存

# ==============================================================================
# 阶段1: REMAP 阶段 - 设置缓存配置
# ==============================================================================

# API 端点: /locks, /objects/batch - 禁止缓存
cond %{CLIENT-URL:PATH} /^\/locks/ [OR]
cond %{CLIENT-URL:PATH} /\/batch$/
  set-config proxy.config.http.cache.http 0

# 对象下载: /objects/<oid> (排除 /objects/batch) - 启用缓存
cond %{CLIENT-URL:PATH} /^\/objects\/[0-9a-fA-F]{64}/
  set-config proxy.config.http.cache.http 1
  set-config proxy.config.http.cache.cache_responses_to_cookies 1

# ==============================================================================
# 阶段2: READ_RESPONSE_HDR_HOOK - 修改响应头
# ==============================================================================

# 对象下载: 长缓存 365 天 (SHA-256 内容寻址，永久不可变)
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /^\/objects\/[0-9a-fA-F]{64}/
  set-header Cache-Control "public, max-age=31536000, immutable"

