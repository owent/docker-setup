# VS Code / Visual Studio Marketplace 缓存策略
#
# API 格式: /_apis/public/gallery/...
#   - /latest 结尾: 获取最新版本信息，需要较短缓存
#   - /version/<version>: 特定版本信息，可长缓存
#   - 扩展下载 (.vsix): 长期缓存
#
# 缓存策略:
#   - /latest API: 6小时 (平衡更新及时性和缓存效率)
#   - 特定版本 API: 7天
#   - 扩展下载: 由 cache.config 控制 (365天)

# ==============================================================================
# 阶段1: REMAP 阶段 - 启用缓存配置
# ==============================================================================
# 所有 API 请求启用缓存
cond %{CLIENT-URL:PATH} /\/_apis\//
  set-config proxy.config.http.cache.http 1
  set-config proxy.config.http.cache.cache_responses_to_cookies 1

# ==============================================================================
# 阶段2: READ_RESPONSE_HDR_HOOK - 修改响应头添加 Cache-Control
# ==============================================================================

# ------------------------------------------------------------------------------
# /latest API - 获取最新版本信息 - 6小时缓存
# 例: /_apis/public/gallery/vscode/ms-python/python/latest
# ------------------------------------------------------------------------------
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/latest$/
  set-header Cache-Control "public, max-age=21600"

# ------------------------------------------------------------------------------
# /versions API - 特定版本信息 - 7天缓存
# 例: /_apis/public/gallery/vscode/ms-python/python/versions/<version>
# ------------------------------------------------------------------------------
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/versions\/[^\/]+/
  set-header Cache-Control "public, max-age=604800"

# ------------------------------------------------------------------------------
# 其他 API 请求 - 默认 3小时缓存
# ------------------------------------------------------------------------------
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/_apis\//
cond %{CLIENT-URL:PATH} /\/latest$/ [NOT]
cond %{CLIENT-URL:PATH} /\/versions\/[^\/]+/ [NOT]
  set-header Cache-Control "public, max-age=10800"
