# GitHub 下载路径和不可变内容特殊处理
# 对于稳定/不可变的内容，允许长缓存
#
# ATS header_rewrite 语法:
#   条件: cond %{CLIENT-URL:PATH} /regex/
#   操作: set-header <name> <value>
#
# 注意: 需要两个阶段的处理
#   1. REMAP_PSEUDO_HOOK (默认): 设置缓存配置
#   2. READ_RESPONSE_HDR_HOOK: 修改响应头
#
# 缓存策略:
#   - latest/nightly/head 等动态引用: 短缓存 (1小时)
#   - 带版本号/tag 的稳定发布: 长缓存 (7天)

# ==============================================================================
# 阶段1: REMAP 阶段 - 启用缓存配置
# ==============================================================================
# 下载路径 (releases/download, archive, zipball, tarball)
cond %{CLIENT-URL:PATH} /\/releases\/download\// [OR]
cond %{CLIENT-URL:PATH} /\/archive\// [OR]
cond %{CLIENT-URL:PATH} /\/zipball\// [OR]
cond %{CLIENT-URL:PATH} /\/tarball\//
  # 重新启用缓存 (覆盖 bypass_auth.conf 的禁用)
  set-config proxy.config.http.cache.http 1
  set-config proxy.config.http.cache.cache_responses_to_cookies 1

# GitHub 主站带 commit ID 的页面
cond %{CLIENT-URL:PATH} /\/[^\/]+\/[^\/]+\/(tree|commit|blob)\/[0-9a-fA-F]{40,64}/
  set-config proxy.config.http.cache.http 1
  set-config proxy.config.http.cache.cache_responses_to_cookies 1

# ==============================================================================
# 阶段2: READ_RESPONSE_HDR_HOOK - 修改响应头添加 Cache-Control
# ==============================================================================

# ------------------------------------------------------------------------------
# 动态引用路径 (latest, nightly, head, main, master 等) - 短缓存 1小时
# 这些引用可能随时指向新版本
# ------------------------------------------------------------------------------
# releases/download/latest 或 releases/latest
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/releases\/(download\/)?latest/i
  set-header Cache-Control "public, max-age=3600"

# archive/zipball/tarball 的 head/main/master/develop 分支
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/(archive|zipball|tarball)\/(head|main|master|develop|trunk)/i
  set-header Cache-Control "public, max-age=3600"

# nightly 构建
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/releases\/download\/nightly/i
  set-header Cache-Control "public, max-age=3600"

# ------------------------------------------------------------------------------
# 带版本号/tag 的稳定发布 - 长缓存 7天
# 匹配: v1.0.0, 1.2.3, release-1.0, 等版本号格式
# ------------------------------------------------------------------------------
# releases/download/<version> (排除 latest/nightly)
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/releases\/download\/[^\/]+\//
cond %{CLIENT-URL:PATH} /\/releases\/download\/(latest|nightly)/i [NOT]
  set-header Cache-Control "public, max-age=604800"

# archive/zipball/tarball 带版本号 (排除 head/main/master/develop)
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/(archive|zipball|tarball)\/[^\/]+/
cond %{CLIENT-URL:PATH} /\/(archive|zipball|tarball)\/(head|main|master|develop|trunk)/i [NOT]
  set-header Cache-Control "public, max-age=604800"

# ------------------------------------------------------------------------------
# GitHub 主站带 commit ID 的页面 (内容不可变) - 长缓存 7天
# ------------------------------------------------------------------------------
cond %{READ_RESPONSE_HDR_HOOK}
cond %{CLIENT-URL:PATH} /\/[^\/]+\/[^\/]+\/(tree|commit|blob)\/[0-9a-fA-F]{40,64}/
  set-header Cache-Control "public, max-age=604800"
