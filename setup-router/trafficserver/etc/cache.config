# Apache Traffic Server 缓存策略配置
#
# 语法:
#   dest_domain=<域名> [条件] action=<动作> [参数]
#
# 条件:
#   suffix=<后缀>           匹配 URL 后缀
#   prefix=<前缀>           匹配 URL 路径前缀
#
# 动作:
#   never-cache             禁止缓存
#   ignore-no-cache         忽略 no-cache 头
#   ttl-in-cache=<时间>     设置缓存 TTL
#   revalidate=<时间>       重新验证时间
#
# 时间格式: <数字>d (天), <数字>h (小时), <数字>m (分钟), <数字>s (秒)
#
# 注意:
#   1. 规则按顺序匹配，第一个匹配的规则生效，更具体的规则应放在前面
#   2. 缓存时间与 setup-router/squid 配置保持一致
#   3. 为优化性能，减少 suffix 匹配条目，使用域名级别的默认策略

# ==============================================================================
# GitHub 资产域名 - 长期缓存 (min 7天 / max 30天)
# ==============================================================================
dest_domain=release-assets.githubusercontent.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=objects.githubusercontent.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=codeload.github.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=gist.githubusercontent.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=user-attachments.githubusercontent.com action=ignore-no-cache ttl-in-cache=30d

# GitHub Raw - Immutable Commit ID (SHA-1/SHA-256) -> Long Cache (365d)

# GitHub Raw - 短期缓存 (脚本等可能频繁更新)
dest_domain=raw.githubusercontent.com action=ignore-no-cache ttl-in-cache=30m revalidate=5m

# GitHub 主站 - Git 端点禁止缓存
dest_domain=github.com suffix=/info/refs action=never-cache
dest_domain=github.com suffix=/git-upload-pack action=never-cache
dest_domain=github.com suffix=/git-receive-pack action=never-cache

# GitHub LFS - API 端点禁止缓存
dest_domain=lfs.github.com prefix=/locks action=never-cache
dest_domain=lfs.github.com suffix=/batch action=never-cache
# GitHub LFS - 对象下载长期缓存 (SHA-256 内容寻址，不可变)
dest_domain=lfs.github.com prefix=/objects action=ignore-no-cache ttl-in-cache=365d
# GitHub LFS - 其他端点默认禁止缓存
dest_domain=lfs.github.com action=never-cache

# GitHub 主站 - releases/archive 下载长期缓存
dest_domain=github.com prefix=/releases/download action=ignore-no-cache ttl-in-cache=30d
dest_domain=github.com prefix=/archive action=ignore-no-cache ttl-in-cache=30d

# GitHub 主站 - Immutable Commit ID (tree/commit) -> Long Cache (365d)

# GitHub 主站 - 其他页面短期缓存
dest_domain=github.com action=ignore-no-cache ttl-in-cache=30m revalidate=3m

# ==============================================================================
# GitHub Pages / 静态站点 / Helm 仓库
# ==============================================================================
# Helm 包文件 (.tgz) - 版本化，长期缓存 (30天/365天)
dest_domain=grafana.github.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=charts.jenkins.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=updates.jenkins.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=get.jenkins.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=openebs.github.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=helm.goharbor.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=opensearch-project.github.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=git.rancher.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=charts.rancher.io suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirror.freedif.org suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirror.ossplanet.net suffix=.tgz action=ignore-no-cache ttl-in-cache=365d

# 静态资源 - 中期缓存 (24h)
dest_domain=grafana.github.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=charts.jenkins.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=updates.jenkins.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=get.jenkins.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=openebs.github.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=helm.goharbor.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=opensearch-project.github.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=git.rancher.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=charts.rancher.io action=ignore-no-cache ttl-in-cache=24h
dest_domain=mirror.freedif.org action=ignore-no-cache ttl-in-cache=24h
dest_domain=mirror.ossplanet.net action=ignore-no-cache ttl-in-cache=24h

# ==============================================================================
# CDN - 版本化内容长期缓存 (30天/365天)
# URL 中带版本号的 CDN 内容不可变
# ==============================================================================
dest_domain=cdnjs.cloudflare.com action=ignore-no-cache ttl-in-cache=365d
dest_domain=cdn.staticfile.org action=ignore-no-cache ttl-in-cache=365d
dest_domain=cdn.bootcdn.net action=ignore-no-cache ttl-in-cache=365d
dest_domain=stackpath.bootstrapcdn.com action=ignore-no-cache ttl-in-cache=365d
dest_domain=fonts.gstatic.com action=ignore-no-cache ttl-in-cache=365d
dest_domain=ajax.googleapis.com action=ignore-no-cache ttl-in-cache=365d

# jsdelivr/unpkg - 严格 SemVer 版本号 (@X.Y.Z) 长期缓存

# jsdelivr/unpkg - @latest 短期缓存，带版本号长期缓存
# 由于 ATS cache.config 不支持正则，使用域名默认策略
# 为了防止 @latest 缓存过久，折中使用 1 天缓存 (Squid 区分版本号可长达 1 年)
dest_domain=cdn.jsdelivr.net action=ignore-no-cache ttl-in-cache=1d
dest_domain=unpkg.com action=ignore-no-cache ttl-in-cache=1d
dest_domain=www.unpkg.com action=ignore-no-cache ttl-in-cache=1d

# Google Fonts CSS - 短期缓存 (内容随 User-Agent 变化)
dest_domain=fonts.googleapis.com action=ignore-no-cache ttl-in-cache=1d

# ==============================================================================
# ESM CDN - 版本化长期缓存
# ==============================================================================
# esm.sh: 匹配 /vNNN/ 或 @x.y.z 版本号 -> 长期缓存 365d
#  - /v135/react@18.2.0/... (build version)
#  - /react@18.2.0/... (exact version)

# cdn.skypack.dev: 
#  - /-/... (pinned URL, immutable) -> 365d
#  - /pin/... -> 365d

# ga.jspm.io: 路径包含严格版本号 @x.y.z -> 365d

# ESM CDN 默认策略 (包括 esm.sh/react, skypack/react 等 lookup 请求)
# 为了及时获取新版本，采用较短缓存
dest_domain=esm.sh action=ignore-no-cache ttl-in-cache=1h
dest_domain=esm.run action=ignore-no-cache ttl-in-cache=1h
dest_domain=cdn.skypack.dev action=ignore-no-cache ttl-in-cache=1h
dest_domain=ga.jspm.io action=ignore-no-cache ttl-in-cache=1h

# ==============================================================================
# Web App (diagrams.net) - 静态资源中期缓存
dest_domain=app.diagrams.net action=ignore-no-cache ttl-in-cache=1d
dest_domain=viewer.diagrams.net action=ignore-no-cache ttl-in-cache=1d

# ==============================================================================
# Microsoft 下载 - 长期缓存 (30天/365天)
# ==============================================================================
# VS Code / Visual Studio 组件更新较大，尽量缓存
# 注意：引导程序(exe)可能更新，仅对明确的大文件后缀设置长缓存 (365d)
# Windows Update / Microsoft Download
dest_domain=download.microsoft.com suffix=.cab action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.microsoft.com suffix=.iso action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.microsoft.com suffix=.msi action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.microsoft.com suffix=.msix action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.microsoft.com action=ignore-no-cache ttl-in-cache=1h

dest_domain=download.windowsupdate.com suffix=.cab action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.windowsupdate.com suffix=.psf action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.windowsupdate.com suffix=.esd action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.windowsupdate.com action=ignore-no-cache ttl-in-cache=1h

dest_domain=dl.delivery.mp.microsoft.com suffix=.cab action=ignore-no-cache ttl-in-cache=365d
dest_domain=dl.delivery.mp.microsoft.com suffix=.wim action=ignore-no-cache ttl-in-cache=365d
dest_domain=dl.delivery.mp.microsoft.com suffix=.esd action=ignore-no-cache ttl-in-cache=365d
dest_domain=dl.delivery.mp.microsoft.com action=ignore-no-cache ttl-in-cache=1h

# Visual Studio
dest_domain=download.visualstudio.microsoft.com suffix=.vsix action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.visualstudio.microsoft.com suffix=.msi action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.visualstudio.microsoft.com suffix=.cab action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.visualstudio.microsoft.com suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.visualstudio.microsoft.com action=ignore-no-cache ttl-in-cache=1h

dest_domain=download.visualstudio.com suffix=.vsix action=ignore-no-cache ttl-in-cache=365d
dest_domain=download.visualstudio.com action=ignore-no-cache ttl-in-cache=1h

# VS Code
dest_domain=vscode.download.prss.microsoft.com suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=vscode.download.prss.microsoft.com suffix=.msi action=ignore-no-cache ttl-in-cache=365d
dest_domain=vscode.download.prss.microsoft.com action=ignore-no-cache ttl-in-cache=1h

# Office CDN
dest_domain=officecdn.microsoft.com suffix=.cab action=ignore-no-cache ttl-in-cache=1h
dest_domain=officecdn.microsoft.com suffix=.dat action=ignore-no-cache ttl-in-cache=365d
dest_domain=officecdn.microsoft.com action=ignore-no-cache ttl-in-cache=1h

# VS Code Marketplace 扩展 - 长期缓存
dest_domain=cdn.vsassets.io action=ignore-no-cache ttl-in-cache=365d
dest_domain=ms-python.gallerycdn.vsassets.io action=ignore-no-cache ttl-in-cache=365d
dest_domain=ms-toolsai.gallerycdn.vsassets.io action=ignore-no-cache ttl-in-cache=365d
dest_domain=ms-vscode.gallerycdn.vsassets.io action=ignore-no-cache ttl-in-cache=365d

# Microsoft CDN 静态资源 - 长期缓存 (30天/365天)
dest_domain=ajax.aspnetcdn.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=ajax.microsoft.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=globalcdn.nuget.org action=ignore-no-cache ttl-in-cache=365d

# API/元数据 - 短期缓存 (1小时)
dest_domain=update.code.visualstudio.com action=ignore-no-cache ttl-in-cache=1h
dest_domain=api.nuget.org action=ignore-no-cache ttl-in-cache=1h
dest_domain=marketplace.visualstudio.com action=ignore-no-cache ttl-in-cache=1h

# ==============================================================================
# Unity - 长期缓存 (7天/30天)
# ==============================================================================
dest_domain=download.unity3d.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=beta.unity3d.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=netstorage.unity3d.com action=ignore-no-cache ttl-in-cache=30d
dest_domain=public-cdn.cloud.unity3d.com action=ignore-no-cache ttl-in-cache=30d

# Unity 包管理 - 短期缓存 (1小时/24小时)
dest_domain=packages.unity.com action=ignore-no-cache ttl-in-cache=1d

# ==============================================================================
# Unreal Engine - 长期缓存 (30天/30天)
# ==============================================================================
dest_domain=cdn.unrealengine.com action=ignore-no-cache ttl-in-cache=30d

# ==============================================================================
# Golang - 版本化长期缓存
# ==============================================================================
# 版本化模块文件 (.mod, .zip, .info) - 永久缓存 (30天/365天)
# URL: /module/@v/vX.Y.Z.ext
# Go Proxy 协议保证已发布的版本不可变 (immutable)

# list 查询: 动态返回可用版本列表 - 短期缓存 (5分钟)

# @latest 查询: 动态返回最新版本 - 短期缓存 (5分钟)

# sum.golang.org 校验数据库
# /lookup/ -> 动态查询 hash -> 短期缓存
# /tile/ -> Merkle Tree 节点 -> 静态不可变 -> 长期缓存

# Golang 其它默认策略
dest_domain=proxy.golang.org action=ignore-no-cache ttl-in-cache=1h
dest_domain=sum.golang.org action=ignore-no-cache ttl-in-cache=1h

# ==============================================================================
# Maven / Gradle - 版本化长期缓存 (365天)
# ==============================================================================
# SNAPSHOT 版本 (开发中非稳定版) - 短期缓存

# maven-metadata.xml (元数据，指示最新版本) - 短期缓存

# Release 版本 artifact - 永久缓存
# 排除 SNAPSHOT 和 metadata 后，剩余带版本号的 jar/pom/aar 均视为 Release
# 由于 Maven 仓库结构通常为 /group/artifact/version/file，只要不含 SNAPSHOT 即可认为安全
dest_domain=repo1.maven.org suffix=.jar action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.pom action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.aar action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.war action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.module action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.sha1 action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.md5 action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo1.maven.org suffix=.asc action=ignore-no-cache ttl-in-cache=365d

# Maven Default
dest_domain=repo1.maven.org action=ignore-no-cache ttl-in-cache=1d

# Apache Maven 仓库
dest_domain=repo.maven.apache.org suffix=.jar action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo.maven.apache.org suffix=.pom action=ignore-no-cache ttl-in-cache=365d
dest_domain=repo.maven.apache.org action=ignore-no-cache ttl-in-cache=1d

# Gradle 插件
dest_domain=plugins.gradle.org suffix=.jar action=ignore-no-cache ttl-in-cache=365d
dest_domain=plugins.gradle.org suffix=.pom action=ignore-no-cache ttl-in-cache=365d
dest_domain=plugins.gradle.org suffix=.module action=ignore-no-cache ttl-in-cache=365d
dest_domain=plugins.gradle.org action=ignore-no-cache ttl-in-cache=1d

# ==============================================================================
# Python / PyPI - 版本化长期缓存 (30天/365天)
# ==============================================================================
# 包文件 - 永久缓存
dest_domain=files.pythonhosted.org suffix=.whl action=ignore-no-cache ttl-in-cache=365d
dest_domain=files.pythonhosted.org suffix=.tar.gz action=ignore-no-cache ttl-in-cache=365d
dest_domain=files.pythonhosted.org suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=files.pythonhosted.org suffix=.egg action=ignore-no-cache ttl-in-cache=365d
dest_domain=files.pythonhosted.org action=ignore-no-cache ttl-in-cache=30d

# 镜像站包文件 (Tuna/Aliyun/Tencent)
dest_domain=pypi.tuna.tsinghua.edu.cn suffix=.whl action=ignore-no-cache ttl-in-cache=365d
dest_domain=pypi.tuna.tsinghua.edu.cn suffix=.tar.gz action=ignore-no-cache ttl-in-cache=365d
dest_domain=pypi.tuna.tsinghua.edu.cn suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=pypi.tuna.tsinghua.edu.cn suffix=.egg action=ignore-no-cache ttl-in-cache=365d

dest_domain=mirrors.aliyun.com suffix=.whl action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.aliyun.com suffix=.tar.gz action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.aliyun.com suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.aliyun.com suffix=.egg action=ignore-no-cache ttl-in-cache=365d

dest_domain=mirrors.cloud.tencent.com suffix=.whl action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.cloud.tencent.com suffix=.tar.gz action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.cloud.tencent.com suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.cloud.tencent.com suffix=.egg action=ignore-no-cache ttl-in-cache=365d

# PyPI API / 镜像元数据 - 短期缓存 (1小时)
dest_domain=pypi.org action=ignore-no-cache ttl-in-cache=1h
dest_domain=pypi.python.org action=ignore-no-cache ttl-in-cache=1h
dest_domain=pypi.tuna.tsinghua.edu.cn action=ignore-no-cache ttl-in-cache=1h
dest_domain=mirrors.aliyun.com action=ignore-no-cache ttl-in-cache=1h
# mirrors.cloud.tencent.com 在 Node.js 部分会被设置为 1h，此处不重复设置默认值

# ==============================================================================
# Node.js / npm / Yarn - 版本化长期缓存
# ==============================================================================
# npm 包文件 (.tgz) - 永久缓存
dest_domain=registry.npmjs.org suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=registry.yarnpkg.com suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=registry.npmmirror.com suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=cdn.npmmirror.com suffix=.tgz action=ignore-no-cache ttl-in-cache=365d
dest_domain=mirrors.cloud.tencent.com suffix=.tgz action=ignore-no-cache ttl-in-cache=365d

# npm 元数据 - 短期缓存 (1小时)
dest_domain=registry.npmjs.org action=ignore-no-cache ttl-in-cache=1h
dest_domain=registry.yarnpkg.com action=ignore-no-cache ttl-in-cache=1h
dest_domain=registry.npmmirror.com action=ignore-no-cache ttl-in-cache=1h
dest_domain=cdn.npmmirror.com action=ignore-no-cache ttl-in-cache=1h
dest_domain=mirrors.cloud.tencent.com action=ignore-no-cache ttl-in-cache=1h

# ==============================================================================
# CMake - 版本化长期缓存 (365天)
# ==============================================================================
dest_domain=cmake.org suffix=.tar.gz action=ignore-no-cache ttl-in-cache=365d
dest_domain=cmake.org suffix=.tar.xz action=ignore-no-cache ttl-in-cache=365d
dest_domain=cmake.org suffix=.zip action=ignore-no-cache ttl-in-cache=365d
dest_domain=cmake.org suffix=.msi action=ignore-no-cache ttl-in-cache=365d
dest_domain=cmake.org suffix=.dmg action=ignore-no-cache ttl-in-cache=365d
dest_domain=cmake.org suffix=.sh action=ignore-no-cache ttl-in-cache=365d
# CMake 版本化文档 (如 /cmake/help/v3.28/) - 长期缓存
dest_domain=cmake.org prefix=/cmake/help/v action=ignore-no-cache ttl-in-cache=365d
# CMake latest 文档 - 中期缓存 (可能更新)
dest_domain=cmake.org prefix=/cmake/help/latest action=ignore-no-cache ttl-in-cache=7d
# CMake 其他页面 - 短期缓存
dest_domain=cmake.org action=ignore-no-cache ttl-in-cache=1d

# ==============================================================================
# C++ 文档 - 中期缓存 (3天/7天)
# ==============================================================================
dest_domain=en.cppreference.com action=ignore-no-cache ttl-in-cache=7d
dest_domain=cppreference.com action=ignore-no-cache ttl-in-cache=7d
dest_domain=zh.cppreference.com action=ignore-no-cache ttl-in-cache=7d
dest_domain=cplusplus.com action=ignore-no-cache ttl-in-cache=7d
dest_domain=www.cplusplus.com action=ignore-no-cache ttl-in-cache=7d
dest_domain=isocpp.org action=ignore-no-cache ttl-in-cache=7d

# Boost - 版本化下载长期缓存，latest 短期缓存
dest_domain=www.boost.org suffix=.tar.gz action=ignore-no-cache ttl-in-cache=30d
dest_domain=www.boost.org suffix=.tar.bz2 action=ignore-no-cache ttl-in-cache=30d
dest_domain=www.boost.org suffix=.zip action=ignore-no-cache ttl-in-cache=30d
dest_domain=www.boost.org suffix=.7z action=ignore-no-cache ttl-in-cache=30d
dest_domain=www.boost.org action=ignore-no-cache ttl-in-cache=7d
dest_domain=boost.org action=ignore-no-cache ttl-in-cache=7d
